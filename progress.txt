# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: Epic 46 - Service Badges (In Progress)
**Total Stories**: 47 stories (27 passes: true, 20 remaining)

---

## 2026-01-18: US-46.3 - Add sonarr_title_slug to Library Backend

### Summary
Added `sonarr_title_slug` field to the Library API so that Sonarr links can be generated on the Library page for series items.

### Files Changed
- `backend/app/models/content.py` - Added `sonarr_title_slug: str | None = None` to LibraryItem model
- `backend/app/services/content.py` - Modified `get_library()` to enrich series with Sonarr titleSlug
- `backend/tests/test_library.py` - Added 2 unit tests for sonarr_title_slug behavior
- `backend/tests/test_integration.py` - Updated required fields check to include sonarr_title_slug

### Key Implementation Details
- Reused `get_sonarr_tmdb_to_slug_map()` pattern from `get_content_issues()` endpoint
- Import inside function to avoid circular imports: `from app.services.sonarr import get_sonarr_tmdb_to_slug_map, get_decrypted_sonarr_api_key`
- Build TMDB -> titleSlug map only when Sonarr is configured (has server_url and api_key_encrypted)
- Series items get titleSlug lookup via TMDB ID from ProviderIds in raw_data
- Movie items always return `sonarr_title_slug: null`

### Verification
- 571 backend tests pass (2 new tests)
- mypy typecheck passes (32 source files)
- 37 integration tests pass (updated required fields check)
- Verified in Docker with integration test

### Learnings
- When mocking functions imported inside another function, patch at the source module (e.g., `app.services.sonarr.get_sonarr_tmdb_to_slug_map`) not at the importing module

---

## 2026-01-18: US-46.2 - Update Issues Page to Use ServiceBadge Component

### Summary
Updated the Issues page to use the new ServiceBadge component, replacing text abbreviations (JF, JS, RD, SN, TMDB) with inline SVG logo icons.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Import ServiceBadge, replace text badges, remove old CSS

### Key Implementation Details
- Imported ServiceBadge component from `$lib/components/ServiceBadge.svelte`
- Replaced 5 text badge links with ServiceBadge component calls
- Removed ~40 lines of `.service-badge-text.*` CSS styles (now in component)
- Existing URL generation functions unchanged (getJellyfinUrl, getJellyseerrUrl, etc.)
- Used nullish coalescing (`?? ''`) for type safety with potentially null URLs

### Verification
- 661 frontend unit tests pass (no new tests needed - component already tested)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: all 5 service logos display as colored circular icons

### Learnings
- Component reuse reduces code duplication - removed ~40 lines of CSS from Issues page
- ServiceBadge component handles all styling internally, simplifying integration

---

## 2026-01-18: US-46.1 - Create ServiceBadge Component with Inline SVG Logos

### Summary
Created a reusable ServiceBadge component with inline SVG icons for all 5 external services: Jellyfin, Jellyseerr, Radarr, Sonarr, and TMDB.

### Files Changed
- `frontend/src/lib/components/ServiceBadge.svelte` - New component with inline SVG icons
- `frontend/tests/service-badge.test.ts` - 28 new unit tests

### Key Implementation Details
- Component accepts props: `service` (type), `url`, `title`
- Inline SVG icons are 16x16 pixels with brand colors:
  - Jellyfin: #00a4dc (blue)
  - Jellyseerr: #7b68ee (purple)
  - Radarr: #ffc230 (yellow)
  - Sonarr: #2ecc71 (green)
  - TMDB: #01b4e4 (blue)
- Links open in new tab with `target="_blank"` and `rel="noopener noreferrer"`
- Hover effect: `transform: scale(1.1)` with opacity change (0.9 → 1)
- Focus outline uses `--brand-color` CSS variable for each service
- SVG icons have `aria-hidden="true"` (decorative, title provides context)

### Verification
- 661 frontend unit tests pass (28 new tests)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Component ready for integration in US-46.2 (Issues page) and US-46.4 (Library page)

### Learnings
- Inline SVG icons work well in both light and dark modes since they use solid fills
- Using `$derived()` for CSS variable computation keeps reactive values clean

---

## 2026-01-18: US-45.6 - Responsive Dashboard Stats Grid

### Summary
Added responsive layout to the Dashboard page, allowing the stats grid to expand on larger screens.

### Files Changed
- `frontend/src/routes/+page.svelte` - Added responsive CSS media queries for dashboard and stats grid

### Key Implementation Details
- Dashboard max-width expands at breakpoints: 800px (default) → 1000px (≥1440px) → 1200px (≥1920px)
- Stats grid gap increases proportionally: space-3 → space-4 (≥1440px) → space-5 (≥1920px)
- Stats grid remains 4 columns with cards growing larger at each breakpoint
- Mobile 2-column grid unchanged (≤640px)

### Verification
- 633 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser via Puppeteer at breakpoints:
  - 800px: Default compact layout
  - 1440px: Expanded layout with max-width 1000px, larger gaps
  - 1920px: Full expansion with max-width 1200px, even larger gaps
  - 640px: Mobile 2-column grid

### Learnings
- Dashboard uses page-specific max-width values (800px → 1000px → 1200px) rather than the global --content-max-width variable since it has a more compact design
- CSS gap property in grid layouts responds well to CSS variable changes for proportional spacing

---

## 2026-01-18: US-45.5 - Responsive Table Columns on Library Page

### Summary
Added responsive column widths to the Library page table, matching the pattern from the Issues page for a consistent experience across pages.

### Files Changed
- `frontend/src/routes/library/+page.svelte` - Added responsive column styles with media queries

### Key Implementation Details
- Page max-width changed from 1000px to `var(--content-max-width)` for responsive layout
- Added `table-layout: fixed` for stable column width calculation
- Base (default): Name 40%, Year 10%, Size 12%, Added 15%, Watched 13%
- Large desktop (≥1440px): Name 44%, Year 9%, Size 10%, Added 13%, Watched 11%
- Ultrawide/4K (≥1920px): Name 48%, Year 8%, Size 9%, Added 12%, Watched 10%
- Each column has min-width values to prevent over-compression
- Mobile column hiding unchanged (Added hidden at ≤768px, Watched hidden at ≤640px)

### Verification
- 633 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser via Puppeteer at breakpoints:
  - 800px: Compact layout with all visible columns fitting
  - 1440px: Expanded layout, Name column has more room
  - 1920px: Full expansion, content spreads nicely
  - 640px: Watched column hidden (mobile)
  - 768px: Added column hidden (tablet)

### Learnings
- Same pattern as Issues page (US-45.4): min-width + percentage widths with table-layout: fixed
- CSS variables from app.css (--content-max-width) enable responsive page widths

---

## 2026-01-18: US-45.4 - Responsive Table Columns on Issues Page

### Summary
Added responsive column widths to the Issues page table, allowing columns to expand at larger breakpoints for better content visibility.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added responsive column styles with media queries

### Key Implementation Details
- Base (default): Name column 32% (min-width 180px), other columns 10%
- Large desktop (≥1440px): Name column 38% (min-width 260px), other columns 9%
- Ultrawide/4K (≥1920px): Name column 42% (min-width 340px), other columns 8%
- Requests view: Name column expanded further (42% → 48% → 52%) since Issues column hidden
- Added `table-layout: fixed` for stable column width calculation
- Page max-width uses `var(--content-max-width)` for layout consistency
- Mobile column hiding unchanged (Size at ≤640px, Watched/Added at ≤768px)

### Verification
- 633 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser via Puppeteer at breakpoints:
  - 800px: Compact layout with truncated titles
  - 1440px: Expanded layout, most titles visible
  - 1920px: Full expansion, long titles like "Spider-Man : Across the Spider-Verse" fully visible
  - 640px: Size column hidden (mobile)
  - Requests tab: Name column properly expanded (Issues column hidden)

### Learnings
- Using `table-layout: fixed` with percentage widths and min-width provides responsive columns
- Media queries at 1440px and 1920px breakpoints match the CSS variables in app.css

---

## 2026-01-18: US-45.3 - Responsive Sidebar Width

### Summary
Updated the sidebar to use CSS variables for responsive width, expanding on larger screens.

### Files Changed
- `frontend/src/lib/components/Sidebar.svelte` - Changed hardcoded 220px to var(--sidebar-width)

### Key Implementation Details
- Sidebar.svelte now uses `width: var(--sidebar-width)` instead of hardcoded `220px`
- CSS variables in app.css (from US-45.1) define the values at each breakpoint:
  - Default: 220px
  - ≥1440px: 260px
  - ≥1920px: 300px
- +layout.svelte already used `var(--sidebar-width)` for margin-left (from US-45.2)
- Mobile sidebar behavior unchanged (still 220px overlay on ≤768px)

### Verification
- 633 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser via Puppeteer at breakpoints:
  - 800px viewport: sidebar = 220px
  - 1440px viewport: sidebar = 260px
  - 1920px viewport: sidebar = 300px
  - Mobile (375px): sidebar hidden, opens as 220px overlay

### Learnings
- Only one file needed to be changed since the CSS variables and layout margin-left were already in place
- The responsive layout system is modular - components just need to use the CSS variables

---

## 2026-01-18: US-45.2 - Expand Main Content Max-Width on Large Screens

### Summary
Updated the main layout to use CSS variables for responsive content width, expanding on larger screens.

### Files Changed
- `frontend/src/routes/+layout.svelte` - Changed hardcoded 1200px and 220px to CSS variables
- `frontend/src/app.css` - Added media queries to update CSS variables at breakpoints

### Key Implementation Details
- `.content { max-width: var(--content-max-width); }` instead of hardcoded 1200px
- `.app.with-sidebar { margin-left: var(--sidebar-width); }` instead of hardcoded 220px
- Media queries at 1440px and 1920px update the CSS variable values:
  - `@media (min-width: 1440px)`: content expands to 1600px
  - `@media (min-width: 1920px)`: content expands to 1800px
- Content remains centered with `margin: 0 auto`
- No horizontal scrollbar at any viewport size

### Verification
- 633 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser via Puppeteer at 800px, 1200px, 1440px, 1920px viewports
- CSS variables confirmed to update at breakpoints
- Content width expands correctly without overflow

### Learnings
- CSS variables in :root can be updated via media queries, making responsive layouts more maintainable
- The same media query updates both content-max-width and sidebar-width for consistency

---

## 2026-01-18: US-45.1 - Add CSS Breakpoints and Variables for Large Screens

### Summary
Added CSS custom properties for large screen breakpoints and responsive layout values to enable progressive layout expansion on larger displays.

### Files Changed
- `frontend/src/app.css` - Added responsive layout system with breakpoints and variables

### Key Implementation Details
- Added breakpoint variables: `--breakpoint-lg: 1440px`, `--breakpoint-xl: 1920px`
- Added sidebar width variables: 220px (default), 260px (lg), 300px (xl)
- Added content max-width variables: 1200px (default), 1600px (lg), 1800px (xl)
- Documented breakpoint strategy in CSS comments explaining mobile-first approach
- Note: CSS media queries cannot use var() directly, so breakpoint values must be hardcoded in @media rules

### Verification
- 633 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Variables verified in browser DevTools via Puppeteer

### Learnings
- CSS custom properties are defined in :root but media query thresholds must use literal values
- Breakpoint variables serve as documentation and reference for consistent values across media queries

---

## 2026-01-18: US-44.7 - Change Password in Settings

### Summary
Added change password functionality to settings. Users can now update their password from a new Security settings page without going through password reset.

### Files Changed
- `backend/app/models/user.py` - Added ChangePasswordRequest/ChangePasswordResponse Pydantic models
- `backend/app/routers/auth.py` - Added POST /api/auth/change-password endpoint
- `backend/tests/test_password_reset.py` - Added 10 new unit tests for change password
- `backend/tests/test_integration.py` - Added 3 integration tests for change password
- `frontend/src/routes/settings/+layout.svelte` - Added Security nav item with lock icon
- `frontend/src/routes/settings/security/+page.svelte` - New security settings page
- `frontend/tests/settings-security.test.ts` - New test file with 17 unit tests

### Key Implementation Details
- POST /api/auth/change-password endpoint requires authentication
- Verifies current password with bcrypt before allowing change
- New password validated via Pydantic: 8+ chars, uppercase, lowercase, number
- Returns 200 on success, 400 if current password wrong, 422 for weak password
- Security settings page has three password inputs with show/hide toggles
- Client-side validation matches backend requirements with real-time feedback
- Confirm password field ensures passwords match before submission

### Verification
- 37 password reset tests pass (10 new change password tests)
- mypy typecheck passes (32 source files)
- svelte-check passes (0 errors, 3 warnings pre-existing)
- 12 auth integration tests pass (3 new change password tests)
- Verified in browser: Security page displays with all inputs and Change Password button

### Learnings
- Reuse existing auth service functions (hash_password, verify_password) for password change
- Client-side password validation should mirror backend requirements for good UX
- Settings sub-pages can be added by creating new directory in routes/settings/

---

## 2026-01-18: US-44.6 - Reset Password UI

### Summary
Created the reset password page with password reset form. Users can enter a new password after clicking a reset link from email.

### Files Changed
- `frontend/src/routes/reset-password/+page.svelte` - New reset password page
- `frontend/src/routes/+layout.svelte` - Added /reset-password to publicRoutes
- `frontend/tests/reset-password.test.ts` - 19 new unit tests

### Key Implementation Details
- Page reads token from URL query param: `/reset-password?token=abc123`
- Shows "Invalid reset link. No token provided." if no token in URL
- Two password inputs with show/hide toggle (eye icons)
- Client-side validation: 8+ chars, uppercase, lowercase, number required
- Validates passwords match before submission (real-time feedback)
- Calls POST /api/auth/reset-password with token and new password
- On success: shows green checkmark message, redirects to /login after 2 seconds
- On 400 error: shows "Invalid or expired token. Please request a new reset link."
- Added /reset-password to publicRoutes for unauthenticated access

### Verification
- 616 frontend unit tests pass (19 new tests)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: page renders correctly
- Verified in browser: no token shows error message
- Verified in browser: password toggle shows/hides text
- Verified in browser: password mismatch validation works
- Verified in browser: invalid token shows error

### Learnings
- Password show/hide toggle uses type="text" vs type="password" toggle
- SVG eye icon changes to eye-off when password is visible
- Client-side password validation should match backend requirements

---

## 2026-01-18: US-44.5 - Forgot Password UI

### Summary
Created the forgot password page with email form to allow users to request a password reset link.

### Files Changed
- `frontend/src/routes/forgot-password/+page.svelte` - New forgot password page
- `frontend/src/routes/login/+page.svelte` - Added "Forgot password?" link
- `frontend/src/routes/+layout.svelte` - Added /forgot-password to publicRoutes
- `frontend/tests/forgot-password.test.ts` - 9 new unit tests

### Key Implementation Details
- Page has email input, "Send Reset Link" button, and "Back to login" link
- On submit: calls POST /api/auth/request-password-reset
- Success state shows green checkmark with message: "If that email exists, a reset link has been sent. Check your inbox."
- Error state shows error message in red box
- Button disabled while request is in flight
- Added /forgot-password to publicRoutes so unauthenticated users can access it
- Styling matches existing auth pages (login, register)

### Verification
- 597 frontend unit tests pass (9 new tests)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: page renders correctly
- Verified in browser: form submission shows success message

### Learnings
- New routes need to be added to publicRoutes in +layout.svelte for unauthenticated access
- Docker containers need to be rebuilt with --no-cache for new routes to be picked up

---

## 2026-01-18: US-43.2 - Fix Warning Color for WCAG AA Compliance

### Summary
Fixed warning colors to meet WCAG AA contrast requirements (4.5:1 for normal text).

### Files Changed
- `frontend/src/app.css` - Updated `--warning` and `--warning-light` colors for light mode
- `frontend/src/lib/components/Toast.svelte` - Changed toast-warning text color to dark amber

### Key Implementation Details
- **Light mode `--warning`**: Changed from `#ca8a04` (2.9:1) to `#a16207` (5.5:1)
- **Light mode `--warning-light`**: Updated rgba() to match new base color
- **Toast warning text**: Changed from `white` to `#451a03` (dark amber) for proper contrast
- **Dark mode unchanged**: `#eab308` already passes WCAG AA (9.3:1 on dark backgrounds)

### Updated Contrast Ratios (WCAG AA = 4.5:1)

| Scenario | Foreground | Background | Contrast | WCAG AA |
|----------|------------|------------|----------|---------|
| Light mode: warning text on white bg | #a16207 | #ffffff | **5.5:1** | ✅ PASS |
| Light mode: dark text on warning toast | #451a03 | #a16207 | **5.5:1** | ✅ PASS |
| Dark mode: warning text on dark bg | #eab308 | #0f172a | **9.3:1** | ✅ PASS |
| Dark mode: dark text on warning toast | #451a03 | #eab308 | **7.8:1** | ✅ PASS |

### Verification
- 588 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: Issues page "Never" text is readable in light mode
- Verified in browser: Library page "Never" text is readable in light mode
- Verified in browser: Settings/Users warning badges are visible in light mode

### Learnings
- WCAG AA requires 4.5:1 contrast for normal text
- Yellow/amber colors are inherently high luminance, requiring darker shades for accessibility
- Toast components with amber backgrounds work better with dark text than white text
- Color `#a16207` (amber-700) maintains visual recognition as amber while meeting contrast requirements

---

## 2026-01-18: US-43.1 - Audit Warning Color Contrast

### Summary
Performed comprehensive WCAG AA contrast audit of warning color usage across the application using contrastchecker.com.

### Contrast Audit Results

| Scenario | Foreground | Background | Contrast | WCAG AA |
|----------|------------|------------|----------|---------|
| Light mode: warning text on white bg | #ca8a04 | #ffffff | **2.94:1** | ❌ FAIL |
| Light mode: warning text on warning-light bg | #ca8a04 | ~#faf3e6 | **2.66:1** | ❌ FAIL |
| Light mode: white text on warning toast bg | #ffffff | #ca8a04 | **2.94:1** | ❌ FAIL |
| Dark mode: warning text on dark bg | #eab308 | #0f172a | **9.31:1** | ✅ PASS |
| Dark mode: warning text on warning-light bg | #eab308 | ~#302e25 | **7.1:1** | ✅ PASS |
| Dark mode: white text on warning toast bg | #ffffff | #eab308 | **1.92:1** | ❌ FAIL |

### Files Using `var(--warning)` That Need Testing
1. `frontend/src/routes/issues/+page.svelte` - `.missing-seasons`, `.badge-large`, `.col-release.future`, `.col-watched.never`
2. `frontend/src/routes/library/+page.svelte` - `.col-watched.never`
3. `frontend/src/routes/content/old-unwatched/+page.svelte` - `.col-status.never-watched`
4. `frontend/src/routes/register/+page.svelte` - `.strength-medium`, `.strength-text-medium`
5. `frontend/src/routes/settings/users/+page.svelte` - Warning badge (!)
6. `frontend/src/lib/components/Toast.svelte` - `.toast-warning`
7. `frontend/src/app.css` - `.badge-warning` global class

### Key Findings
- **Light mode warning color (#ca8a04) fails WCAG AA** on all backgrounds (< 3:1 contrast)
- **Dark mode warning color (#eab308) passes WCAG AA** on dark backgrounds (7-9:1 contrast)
- **Toast warning fails in BOTH modes** because white text on bright yellow/amber doesn't have enough contrast
- The fix (US-43.2) will need to darken the light mode warning color while keeping it recognizable as amber

### Verification
- 588 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Contrast ratios documented using contrastchecker.com

### Learnings
- WCAG AA requires 4.5:1 contrast for normal text
- Yellow/amber colors are inherently difficult for accessibility due to high luminance
- Dark text on warning-light backgrounds is even worse than warning text on white
- Toast components need special consideration - the warning toast pattern (white on amber) is problematic

---

## 2026-01-18: US-42.3 - Use SearchInput in Issues Page

### Summary
Replaced the inline search input in Issues page with the reusable SearchInput component for improved accessibility.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Imported SearchInput component, replaced inline HTML, removed duplicated CSS

### Key Implementation Details
- Imported `SearchInput` component from `$lib/components/SearchInput.svelte`
- Replaced inline `<div class="search-container">...<input>...</div>` with `<SearchInput>` component
- Set `aria-label="Search issues by title or year"` for screen reader accessibility
- Passed existing props: `value={searchQuery}`, `placeholder`, `oninput={handleSearchInput}`, `onclear={clearSearch}`
- Removed ~53 lines of duplicated CSS for `.search-container`, `.search-input`, `.search-clear`

### Verification
- 588 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: search input renders correctly with aria-label
- Verified: debounced search filtering works (1 of 214 items when searching "Malcolm")
- Verified: clear button appears and clears search correctly

### Learnings
- The SearchInput component handles its own styling, so duplicated CSS in parent pages should be removed
- Same pattern as US-42.2 (Library page) - consistent approach across pages

---

## 2026-01-18: US-42.2 - Use SearchInput in Library Page

### Summary
Replaced the inline search input in Library page with the reusable SearchInput component for improved accessibility.

### Files Changed
- `frontend/src/routes/library/+page.svelte` - Imported SearchInput component, replaced inline HTML, removed duplicated CSS

### Key Implementation Details
- Imported `SearchInput` component from `$lib/components/SearchInput.svelte`
- Replaced inline `<div class="search-container">...<input>...</div>` with `<SearchInput>` component
- Set `aria-label="Search library by title or year"` for screen reader accessibility
- Passed existing props: `value={searchQuery}`, `placeholder`, `oninput={handleSearchInput}`, `onclear={clearSearch}`
- Removed ~46 lines of duplicated CSS for `.search-container`, `.search-input`, `.search-clear`

### Verification
- 588 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: search input renders correctly with aria-label
- Verified: debounced search filtering works
- Verified: clear button appears and clears search correctly

### Learnings
- The SearchInput component handles its own styling, so duplicated CSS in parent pages should be removed
- Docker rebuild required for production verification after component changes

---

## 2026-01-18: US-42.1 - Create SearchInput Component

### Summary
Created a reusable SearchInput component with built-in accessibility for consistent search inputs across the app.

### Files Changed
- `frontend/src/lib/components/SearchInput.svelte` - New component file
- `frontend/tests/search-input.test.ts` - New test file with 19 unit tests

### Key Implementation Details
- Props interface: `value`, `placeholder`, `aria-label`, `oninput`, `onclear`
- Input has `type="text"` and `class="search-input"`
- `aria-label` applied to input element for screen reader accessibility
- Clear button appears when value is not empty with `aria-label="Clear search"`
- Same HTML structure (`div.search-container` > `input.search-input` + `button.search-clear`)
- Same CSS classes and styles as existing search inputs in library/issues pages

### Verification
- 588 frontend unit tests pass (19 new tests)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Component compiles correctly and is ready for integration in US-42.2 and US-42.3

### Learnings
- Svelte 5 uses `$props()` rune for prop definitions with TypeScript interface
- The `aria-label` prop must use bracket notation in interface due to hyphen

---

## 2026-01-18: US-41.3 - Auto-Focus and Restore Focus

### Summary
Implemented auto-focus when modals open and focus restoration when modals close for improved keyboard accessibility. Duration picker focuses first radio input, delete modal focuses Cancel button (safer default for destructive actions).

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added trigger refs, capture/restore focus logic, $effect hooks for auto-focus
- `frontend/tests/issues-auto-focus.test.ts` - New test file with 24 unit tests

### Key Implementation Details
- Added `durationPickerTrigger` and `deleteModalTrigger` state refs to store trigger elements
- `openDurationPicker()` and `openDeleteModal()` capture `document.activeElement` before opening
- `closeDurationPicker()` and `closeDeleteModal()` call `trigger.focus()` to restore focus
- Added `$effect` hooks that fire when modal state changes:
  - Duration picker: focuses first radio input (Permanent option)
  - Delete modal: focuses Cancel button (safer default for destructive action)
- Added `onkeydown={handleKeydown}` and `tabindex="-1"` to modal overlays
- Kept `svelte-ignore a11y_click_events_have_key_events` for overlay backdrop (role="presentation" is correct semantic)

### Verification
- svelte-check passes (0 errors, 3 warnings - all pre-existing in other files)
- Verified in browser using Puppeteer:
  - Duration picker: first radio input (value="permanent") receives focus
  - Delete modal: Cancel button receives focus
  - Focus returns to trigger button after closing via Escape, Cancel, or Confirm

### Learnings
- Use `$effect` for side effects that depend on reactive state (like auto-focusing when modal opens)
- Capture `document.activeElement` BEFORE any state changes that might move focus
- For destructive actions, focusing Cancel button is the safer default
- Modal overlays with `role="presentation"` don't need interactive roles (they're visual backdrops)

---

## 2026-01-18: US-41.2 - Implement Keyboard Focus Trap

### Summary
Implemented keyboard focus trap for modal dialogs on the Issues page. Tab and Shift+Tab now cycle through focusable elements within the modal without escaping to background content.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added getFocusableElements() helper, updated handleKeydown() for focus trap, added modal element refs, added tabindex="0" to modals
- `frontend/tests/issues-focus-trap.test.ts` - New test file with 14 unit tests

### Key Implementation Details
- Added `getFocusableElements()` helper function to find all interactive elements (buttons, inputs, selects) within a container
- Extended `handleKeydown()` to handle Tab/Shift+Tab key presses
- Tab from last focusable element wraps to first element
- Shift+Tab from first focusable element wraps to last element
- Added `bind:this` to capture modal element references for focus trap logic
- Added `tabindex="0"` to modal containers for accessibility compliance
- Removed `svelte-ignore a11y_interactive_supports_focus` comments (no longer needed with tabindex)
- Focus trap works for both duration picker modal (7 focusable elements) and delete modal (4 focusable elements)

### Verification
- 552 frontend unit tests pass (14 new tests)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser using Puppeteer:
  - Duration picker: Tab from Confirm wraps to first radio input
  - Duration picker: Shift+Tab from first radio wraps to Confirm button
  - Delete modal: Tab from Delete wraps to first checkbox
  - Both modals have tabindex="0" attribute

### Learnings
- Focus trap pattern: get focusable elements, track current index, wrap at boundaries
- Use `document.activeElement` to determine current focused element
- Use `event.preventDefault()` to stop browser's default Tab behavior before programmatically moving focus
- `tabindex="0"` on modal container makes it focusable and satisfies a11y_interactive_supports_focus warning

---

## 2026-01-18: US-41.1 - Add Escape Key to Close Modals

### Summary
Added Escape key support to close modal dialogs on the Issues page for improved keyboard accessibility.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added handleKeydown() function and svelte:window keydown handler
- `frontend/tests/issues-modal-keyboard.test.ts` - New test file with 8 unit tests

### Key Implementation Details
- Added `handleKeydown()` function that checks for Escape key press
- Uses `svelte:window onkeydown={handleKeydown}` to listen for keyboard events globally
- Closes duration picker modal first if open, otherwise closes delete confirmation modal
- Escape key acts like Cancel button (no destructive action triggered)
- The keydown handler is always active but only responds when a modal is open

### Verification
- 538 frontend unit tests pass (8 new tests)
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser using Puppeteer:
  - Duration picker modal opens, Escape closes it
  - Delete confirmation modal opens, Escape closes it without deleting

### Learnings
- `svelte:window onkeydown={handler}` is the Svelte 5 way to listen for global keyboard events
- No need to add/remove event listeners manually - Svelte handles cleanup
- Checking `showDurationPicker` before `showDeleteModal` ensures the topmost modal closes first

---

## 2026-01-18: US-40.1 - Fix GitHub Repository Link

### Summary
Updated the Help page to link to the correct project repository (jimmydore/mediajanitor) instead of the placeholder link.

### Files Changed
- `frontend/src/routes/help/+page.svelte` - Updated contact section links

### Key Implementation Details
- Changed from single "GitHub Issues" link to anthropics/claude-code
- Now has two links: "view the project on GitHub" and "report an issue"
- Both point to `https://github.com/jimmydore/mediajanitor` and `https://github.com/jimmydore/mediajanitor/issues`
- Links have `target="_blank"` and `rel="noopener noreferrer"` for security

### Verification
- 530 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: links display correctly and have correct href attributes

---

## 2026-01-18: US-39.2 - Add Type Icons to Toasts

### Summary
Added type-specific icons to toast notifications for visual clarity. Success toasts show a checkmark, error toasts show an X, info toasts show an i-circle, and warning toasts show a triangle.

### Files Changed
- `frontend/src/lib/components/Toast.svelte` - Added inline SVG icons for each toast type, added warning toast type
- `frontend/tests/toast.test.ts` - Added 9 new tests for icon functionality

### Key Implementation Details
- Icons are inline SVGs (18x18px) positioned left of message text
- Success: checkmark (M3.5 9.5l4 4 7-8)
- Error: X shape (M4 4l10 10M14 4L4 14)
- Info: i inside circle
- Warning: exclamation inside triangle
- Icons use `stroke="currentColor"` to inherit white text color from toast
- Icon container has `aria-hidden="true"` (decorative, message text conveys meaning)
- Added new `warning` toast type with `--warning` amber background

### Verification
- 530 frontend unit tests pass (9 new tests)
- svelte-check passes (0 errors, 3 warnings - all pre-existing)
- Verified in browser: success toast shows checkmark icon, positioned left of message

### Learnings
- Inline SVGs are more maintainable than external icon libraries for small icon sets
- Using `currentColor` for stroke allows icons to inherit text color from parent

---

## 2026-01-18: US-38.3 - Recently Available Uses Language Preference

### Summary
Implemented language preference support for the Recently Available page. Users can now choose to view and copy content titles in French instead of English.

### Files Changed
- `backend/app/models/content.py` - Added `title_fr` field to `RecentlyAvailableItem` model
- `backend/app/services/content.py` - Return `title_fr` from database in API response
- `frontend/src/routes/info/recent/+page.svelte` - Read `title_language` preference, display titles based on preference, update copy function
- `frontend/tests/info.test.ts` - Added 6 new tests for title_fr field and language preference logic

### Key Implementation Details
- `RecentlyAvailableItem` now includes `title_fr: str | None` field
- Frontend reads `title_language` from `/api/settings/display` on page load
- `getDisplayTitle()` helper returns French title if `titleLanguage === 'fr'` and `title_fr` is available
- Falls back to English title when French title is null/unavailable
- Copy button also uses `getDisplayTitle()` to output titles in preferred language

### Verification
- 556 backend tests pass
- 493 frontend tests pass (6 new tests)
- mypy typecheck passes
- svelte-check passes (0 errors)
- 34 integration tests pass
- Verified in browser: titles switch between English and French based on setting

### Learnings
- The `title_fr` field was already populated during sync (US-38.2), so only API and frontend changes needed
- French title fallback to English happens in the frontend, not the backend

---

## 2026-01-18: US-37.2 - Display Prefilled Users in UI

### Summary
Verified that the display prefilled users feature was already fully implemented in US-36.4 and US-37.1. No code changes needed - just marked the story as complete.

### Existing Implementation
- `frontend/src/routes/settings/users/+page.svelte` - Users page displays prefilled Jellyfin users
- Warning badge (!) next to usernames with `has_jellyseerr_account=false`
- Tooltip explains: "This Jellyfin user was not found in Jellyseerr. They may not be able to request content."
- Empty display names show em-dash (—)
- Edit/delete functionality preserved

### Verification
- 487 frontend unit tests pass (16 for settings-users.test.ts)
- svelte-check passes (0 errors, 3 warnings)
- Verified in browser via Puppeteer: users table shows prefilled Jellyfin users with warning badges

### Key Implementation Details (Pre-existing)
- `has_jellyseerr_account` field added in US-37.1 backend sync
- Warning badge rendered with `{#if nickname.has_jellyseerr_account === false}`
- Empty state only shows when `nicknames.length === 0 && !showAddNicknameForm`

### Learnings
- Before implementing, always check if the feature is already complete by reviewing existing code
- The warning badge styling uses `--warning-light` background with `--warning` text color

---

## 2026-01-16: US-35.1 - Fix Watched Column Sort Order

### Summary
Fixed the Watched column sorting to properly handle three different states: items with dates, items marked as "Watched" (no date), and items marked as "Never" (never watched).

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added 'watched' to SortField type, implemented three-tier sorting logic, updated column header
- `frontend/tests/issues-sorting.test.ts` - New test file for watched column sorting logic

### Key Implementation Details
- Added `watched` to the `SortField` type union
- Implemented three-tier priority system: 1 = has date, 2 = played without date, 3 = never watched
- Descending order (first click): dates DESC → "Watched" → "Never"
- Ascending order (second click): "Never" → "Watched" → dates ASC
- Column header now uses 'watched' field for non-requests tabs (uses 'date' for Requested column)
- Sorting works for both movies and series

### Verification
- 423 frontend unit tests pass (12 new sorting tests)
- svelte-check passes (0 errors)
- Verified in browser using Puppeteer: clicking Watched column sorts correctly in both directions

---

## 2026-01-16: US-34.3 - Add Sorting to Requester and Release Columns

### Summary
Added sorting functionality to Requester and Release columns on the Unavailable tab of the Issues page.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added 'requester' and 'release' to SortField type, sorting logic, and clickable column headers

### Key Implementation Details
- Added `requester` and `release` to the `SortField` type union
- Implemented `requester` sorting: alphabetical comparison with nulls sorted last
- Implemented `release` sorting: date comparison with nulls sorted last
- Wrapped Requester and Release column headers with sort buttons
- Sort indicators (↑/↓) appear on active sort column
- Both columns default to descending order when first clicked

### Verification
- 411 frontend unit tests pass
- svelte-check passes (0 errors)
- Verified in browser using Puppeteer: both columns sort correctly in asc/desc order

---

## 2026-01-16: US-34.2 - Normalize Table Header Casing

### Summary
Changed table headers from ALL CAPS to Title Case for a more professional appearance.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Removed text-transform: uppercase from table header CSS

### Key Implementation Details
- Removed `text-transform: uppercase` and `letter-spacing: 0.05em` from `.issues-table th` CSS rule
- Headers now display as written in HTML: Name, Requester, Issues, Size, Added, Release, Requested/Watched
- Badge text (OLD, LANGUAGE, etc.) still uses uppercase via separate `.badge` CSS rule

### Verification
- 411 frontend unit tests pass
- svelte-check passes (0 errors)
- Verified in Docker: all headers display in Title Case

---

## 2026-01-16: US-34.1 - Hide Issues Column on Unavailable Tab

### Summary
Hid the Issues column on the Unavailable tab to give more space to the content name column.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added conditional rendering for Issues column and CSS for expanded Name column

### Key Implementation Details
- Added `{#if activeFilter !== 'requests'}` around Issues column header and cells
- Added `class:requests-view={activeFilter === 'requests'}` to table element
- Added CSS rule `.requests-view .col-name { width: 45%; }` to expand Name column
- Other tabs (All, Old, Large, Language) still show the Issues column at 35% width

### Verification
- 411 frontend unit tests pass
- svelte-check passes (0 errors)
- Verified in browser: Unavailable tab has no Issues column, Name column is wider
- Verified in browser: All/Old tabs still show Issues column

---

## 2026-01-16: US-44.4 - Reset Password Endpoint

### Summary
Created POST /api/auth/reset-password endpoint that allows users to submit a new password using a valid reset token.

### Files Changed
- `backend/app/models/user.py` - Added `ResetPasswordRequest`, `ResetPasswordResponse` models and `validate_password_strength()` function
- `backend/app/routers/auth.py` - Added `reset_password` endpoint
- `backend/tests/test_password_reset.py` - Added 11 new unit tests (TestResetPasswordEndpoint class)
- `backend/tests/test_integration.py` - Added 3 integration tests for reset-password validation

### Key Implementation Details
- Password validation with Pydantic `field_validator`: 8+ chars, uppercase, lowercase, number
- Iterates through all non-expired, unused tokens and compares bcrypt hashes
- Updates user's `hashed_password` with new bcrypt hash
- Marks token as `used=True` to prevent reuse
- Returns 200 OK with success message on valid reset
- Returns 400 Bad Request for invalid/expired/used tokens
- Returns 422 Unprocessable Entity for weak passwords (validation)

### Verification
- 547 backend tests pass (11 new tests)
- mypy typecheck passes
- 9 auth integration tests pass in Docker

### Learnings
- Pydantic `field_validator` decorator runs during request parsing, catching validation errors before endpoint code
- bcrypt.checkpw is used to safely compare incoming token with stored hashes

---

## 2026-01-16: US-44.3 - Request Password Reset Endpoint

### Summary
Created POST /api/auth/request-password-reset endpoint that allows users to request a password reset email.

### Files Changed
- `backend/app/models/user.py` - Added `PasswordResetRequest` and `PasswordResetResponse` Pydantic models
- `backend/app/routers/auth.py` - Added `request_password_reset` endpoint and `_check_password_reset_rate_limit` helper
- `backend/app/services/rate_limit.py` - Added `password_reset_rate_limiter` (3 requests/email/hour)
- `backend/tests/test_password_reset.py` - Added 10 new unit tests for endpoint and rate limiting
- `backend/tests/test_integration.py` - Added 3 integration tests for password reset endpoint

### Key Implementation Details
- Generates secure random token: `secrets.token_urlsafe(32)` (32 bytes, URL-safe base64)
- Hashes token with bcrypt before storage for security
- Token expires in 15 minutes from creation
- Deletes existing unused tokens for user before creating new one (only one active reset per user)
- Sends email via `send_password_reset_email()` service with reset URL
- Returns 200 OK even for non-existent emails (prevents email enumeration attacks)
- Rate limited to 3 requests per email per hour (in-memory RateLimiter keyed by email)

### Verification
- 533 backend tests pass (10 new tests + 3 integration tests)
- mypy typecheck passes
- 31 integration tests pass in Docker

### Learnings
- Rate limiting by email address (not IP) provides better protection for this endpoint
- The RateLimiter class has `_is_testing()` check that bypasses limits when TESTING=1
- For rate limit tests, must set TESTING=0 with `patch.dict(os.environ)` pattern

---

## 2026-01-16: US-44.2 - Email Service with SMTP2GO

### Summary
Created email service to send password reset emails using SMTP with STARTTLS.

### Files Changed
- `backend/app/config.py` - Added SMTP config settings (smtp_host, smtp_port, smtp_username, smtp_password, smtp_from_email, frontend_url)
- `backend/app/services/email.py` - New email service with send_password_reset_email() function
- `backend/tests/test_email.py` - 18 unit tests with mocked smtplib.SMTP

### Key Implementation Details
- Uses smtplib with STARTTLS for secure connection
- Sends both HTML and plain text email formats (multipart/alternative)
- Email includes: reset link (clickable), expiration time (15 minutes), user's email for reference
- Raises HTTPException 500 on SMTP errors (authentication, connection, general SMTP errors)
- Skips login if username/password are empty (for testing with local SMTP servers)
- Logs success message on email sent

### Verification
- 523 backend tests pass (18 new email tests)
- mypy typecheck passes

### Learnings
- smtplib context manager (`with`) automatically handles quit/disconnect
- MIMEMultipart("alternative") lets email clients choose HTML or plain text

---

## 2026-01-16: US-44.1 - Password Reset Token Model

### Summary
Created `PasswordResetToken` database model to store password reset tokens securely for the forgot password feature.

### Files Changed
- `backend/app/database.py` - Added `PasswordResetToken` model with all required fields
- `backend/alembic/versions/20260116_203015_*.py` - Migration to create table
- `backend/tests/test_password_reset.py` - Unit tests for model CRUD and constraints

### Key Implementation Details
- Fields: `id`, `user_id`, `token_hash`, `expires_at`, `created_at`, `used`
- `token_hash` column is indexed for fast lookup
- Foreign key to `users` table with `ON DELETE CASCADE` - tokens deleted when user is deleted
- `used` boolean flag to prevent token reuse

### Verification
- 505 backend tests pass (6 new tests for PasswordResetToken model)
- mypy typecheck passes
- 28 integration tests pass in Docker
- Table verified in Docker database with correct columns and foreign key

### Learnings
- CASCADE delete in SQLAlchemy requires `ondelete="CASCADE"` in ForeignKey definition
- SQLite in-memory tests may not enforce foreign keys (engine-specific behavior)

---

## 2026-01-16: US-33.1 - Calculate and Store Total Series Size

### Summary
Modified `calculate_season_sizes()` to also calculate and store the total series size (sum of all seasons) in `CachedMediaItem.size_bytes`. This enables the Library page to display actual series sizes instead of "Unknown size".

### Files Changed
- `backend/app/services/sync.py` - Added `total_series_size` accumulator, store in `size_bytes`
- `backend/tests/test_sync.py` - Added tests for total series size calculation

### Key Implementation Details
- `calculate_season_sizes()` now tracks both `largest_season_size` and `total_series_size`
- For each season, the season size is added to `total_series_size`
- After processing all seasons, `size_bytes` is updated with the total
- Log message now includes both total size and largest season size for debugging
- Frontend already uses `size_formatted` from API, so no frontend changes needed

### Verification
- 491 backend tests pass (added 1 new test for total series size)
- All 405 frontend tests pass
- mypy typecheck passes
- svelte-check passes
- 27 integration tests pass in Docker

### Learnings
- The `format_size()` function returns "Unknown size" when `size_bytes` is None or 0
- Once `size_bytes` is populated during sync, the Library page will automatically display proper sizes

---

## 2026-01-16: US-17.2.1 - Populate Sync Progress User Names

### Summary
Verified that sync progress user names feature was already fully implemented. No code changes needed - just marked the story as complete.

### Existing Implementation
- `backend/app/services/sync.py:456-460` - Extracts first user name in batch and passes to `update_sync_progress()`
- `frontend/src/routes/+page.svelte:159-160` - Displays "Fetching user X/Y: Name..." format

### Verification
- All 491 backend tests pass including `TestSyncProgressTracking` tests
- All 405 frontend tests pass including sync.test.ts and setup-checklist.test.ts
- Typecheck passes (mypy, svelte-check)
- Integration tests pass in Docker
- Visual verification attempted via Puppeteer (sync completes too fast to capture mid-progress)

### Key Implementation Details (Pre-existing)
- `fetch_jellyfin_media_with_progress()` processes users in batches of 3
- For each batch, it extracts the first user's display name: `first_user_name = batch_users[0].get("Name", "Unknown")`
- Passes this name to `update_sync_progress()` which stores it in `SyncStatus.current_user_name`
- API endpoint `/api/sync/status` returns the name in `progress.current_user_name`
- Frontend `formatProgressMessage()` formats: `Fetching user ${progress.current_step_progress}/${progress.current_step_total}: ${userName}...`

### Learnings
- Before implementing, always check if the feature is already complete by reviewing existing code
- The sync progress user names feature was implemented alongside the main sync progress tracking

---

## 2026-01-16: US-38.2 - Store French Titles During Sync

### Summary
Added ability to fetch and store French titles during sync, enabling future display of content in French.

### Files Changed
- `backend/app/database.py` - Added `title_fr` column to `CachedJellyseerrRequest` model
- `backend/app/services/sync.py` - Added `language` parameter to `fetch_media_details()`, added `extract_french_title_from_request()` helper, updated sync to fetch both English and French titles
- `backend/tests/test_sync.py` - Added tests for French title extraction and fetch_media_details with language
- `backend/alembic/versions/20260116_192531_*.py` - Migration for `title_fr` column

### Key Implementation Details
- `fetch_media_details()` now accepts `language` parameter (default: "en")
- During sync, the service makes two API calls per media item: one for English, one for French
- French titles are stored in `title_fr` (movies use `title_fr`, TV shows use `name_fr` from media details)
- `extract_french_title_from_request()` extracts French title from media object
- Missing French titles are stored as None (graceful degradation)
- Uses separate caches for EN and FR to avoid duplicate lookups

### Learnings
- The Jellyseerr API accepts a `language` parameter to fetch localized titles from TMDB
- Caching both languages separately prevents redundant API calls for the same TMDB ID

---

## 2026-01-16: US-38.1 - Add Title Language User Setting

### Summary
Added user setting to choose preferred language (English or French) for content titles. This is the first step toward supporting French title display.

### Files Changed
- `backend/app/database.py` - Added `title_language` column to `UserSettings` (String(2), default='en')
- `backend/app/models/settings.py` - Added `TitleLanguage` Literal type and fields to display preferences models
- `backend/app/routers/settings.py` - Updated GET/POST display endpoints to include `title_language`
- `backend/tests/test_integration.py` - Added integration tests for title_language API
- `backend/alembic/versions/20260116_191223_*.py` - Migration for `title_language` column
- `frontend/src/routes/settings/+page.svelte` - Added "Title language" dropdown to Display section

### Key Implementation Details
- TitleLanguage is a Literal type: `"en" | "fr"`
- Default value is "en" (English)
- Migration includes `server_default='en'` for existing rows
- Frontend dropdown saves on change (no save button needed)
- Includes proper loading states and error handling

### Learnings
- When adding a new NOT NULL column, always include `server_default` in migration for existing rows

---

## 2026-01-16: US-37.1 - Prefill Nicknames During Sync (Backend)

### Summary
Implemented automatic prefill of nickname records for all Jellyfin users during sync, including detection of users with Jellyseerr accounts.

### Files Changed
- `backend/app/database.py` - Added `has_jellyseerr_account` boolean field to `UserNickname` model
- `backend/app/models/settings.py` - Added `has_jellyseerr_account` to `NicknameItem` response model
- `backend/app/services/sync.py` - Added `fetch_jellyseerr_users()` and `prefill_user_nicknames()` functions
- `backend/app/services/nicknames.py` - Updated to include `has_jellyseerr_account` in list response
- `backend/app/routers/settings.py` - Updated nickname endpoints to return `has_jellyseerr_account`
- `backend/tests/test_nickname_prefill.py` - New test file for nickname prefill functionality
- `backend/tests/test_sync.py` - Updated existing tests to mock new functions
- `backend/tests/test_sync_mocked_integration.py` - Added Jellyseerr users mock
- `backend/alembic/versions/20260116_184830_*.py` - Migration for `has_jellyseerr_account` column

### Key Implementation Details
- `fetch_jellyseerr_users()` calls `/api/v1/user` endpoint and returns empty list on error (graceful degradation)
- `prefill_user_nicknames()` creates nickname records for each Jellyfin user during sync
  - Preserves existing mappings (only creates if not exists)
  - Matches Jellyfin usernames against Jellyseerr users (case-insensitive)
  - Sets `has_jellyseerr_account=True` for users found in Jellyseerr
- Display name is left empty for user to fill in later

### Learnings
- When adding new API calls to sync service, remember to update all existing sync tests to mock the new functions
- `respx` mocks require explicit routes for every HTTP call made during test

---

## 2026-01-16: US-37.3 - Manual Refresh Button for Jellyfin Users

### Summary
Added a "Refresh users" button on the Settings page that allows users to manually fetch Jellyfin users and populate the nickname list without waiting for the next sync.

### Files Changed
- `backend/app/models/settings.py` - Added `NicknameRefreshResponse` model
- `backend/app/routers/settings.py` - Added `POST /api/settings/nicknames/refresh` endpoint
- `backend/tests/test_settings.py` - Added 6 tests for refresh endpoint
- `backend/tests/test_integration.py` - Added integration test for refresh endpoint
- `frontend/src/routes/settings/+page.svelte` - Added "Refresh users" button with loading state
- `frontend/tests/settings-nicknames.test.ts` - Added 6 tests for refresh API contract

### Key Implementation Details
- Endpoint reuses existing `fetch_jellyfin_users()`, `fetch_jellyseerr_users()`, and `prefill_user_nicknames()` from sync service
- Returns 400 if Jellyfin not configured, 500 if Jellyfin API fails
- Response includes `success`, `message` (human-readable), and `new_users_count`
- Button only visible when `hasJellyfinConfigured` is true
- Shows loading spinner and disables button during refresh

### Verification
- 498 backend tests pass (6 new tests)
- 411 frontend tests pass (6 new tests)
- 28 integration tests pass (1 new test)
- mypy typecheck passes
- svelte-check passes

### Learnings
- Can reuse sync service functions in settings router by importing from `app.services.sync`
- Import `Any` from typing when using `dict[str, Any]` type hints

---

## 2025-01-16: US-28.1 - Loading States Accessibility

### Summary
Added accessibility attributes to loading states across all main pages so screen readers can announce loading status and content updates.

### Files Changed
- `frontend/src/routes/+page.svelte` - Dashboard with aria-busy, aria-live on stats grid
- `frontend/src/routes/issues/+page.svelte` - Issues page with aria-busy, aria-live on table
- `frontend/src/routes/settings/+page.svelte` - Settings page with aria-busy, role="status" on loading
- `frontend/src/routes/library/+page.svelte` - Library page with aria-busy, aria-live on table
- `frontend/src/routes/whitelist/+page.svelte` - Whitelist page with aria-busy, aria-live on list
- `frontend/src/routes/info/recent/+page.svelte` - Recent page with aria-busy, aria-live on table

### Key Implementation Details
- `aria-busy="true/false"` on parent containers (dashboard, issues-page, settings-page, library-page, whitelist-page, page) - dynamically set based on loading state
- `role="status"` and `aria-label="Loading..."` on loading div elements
- `aria-hidden="true"` on spinner elements (decorative)
- `aria-live="polite"` on table/list containers that update with content
- `aria-live="assertive"` on toast notifications

### Verification
- 523 backend tests pass
- 411 frontend tests pass
- svelte-check passes (0 errors)
- Verified in browser using Puppeteer - all aria attributes present

### Learnings
- `aria-busy` should be on the container that changes during load (toggles between content and loading state)
- `aria-live="polite"` announces updates without interrupting the user
- `aria-live="assertive"` for urgent messages like error toasts
- Spinners should have `aria-hidden="true"` since the `role="status"` on parent provides context

---

## 2026-01-18: US-35.2 - Display Last Watched Date for Series

### Summary
Fixed series showing "Watched" instead of actual last watched date. Jellyfin tracks watch data at the episode level, not the series level. Modified the sync process to fetch episode UserData from all Jellyfin users and aggregate the most recent LastPlayedDate.

### Files Changed
- `backend/app/services/sync.py` - Added get_most_recent_episode_played_date(), modified fetch_season_episodes() and calculate_season_sizes()
- `backend/tests/test_sync.py` - Added 6 new tests for get_most_recent_episode_played_date(), updated existing tests with mock for fetch_jellyfin_users

### Key Implementation Details
- `fetch_season_episodes()` now accepts optional `jellyfin_user_id` parameter and includes `UserData` in API request
- `calculate_season_sizes()` fetches all Jellyfin users, then for each season fetches episode UserData for each user
- `get_most_recent_episode_played_date()` iterates through all episodes and returns the most recent LastPlayedDate
- Frontend `formatLastWatched()` already displays dates correctly when data is present

### Root Cause Analysis
- Jellyfin API returns `UserData.LastPlayedDate` at the episode level, not series level
- Series items have `played=True` but `LastPlayedDate=None` in the API response
- Previous sync only stored the series-level UserData which lacked the date

### Verification
- 97 sync tests pass (6 new tests for get_most_recent_episode_played_date)
- mypy typecheck passes (32 source files)
- Manual testing requires a full sync to populate episode watch data

### Learnings
- Jellyfin stores watch data per-episode, aggregated data must be computed
- When adding new dependencies in functions, update existing test mocks accordingly
- Consider API rate limiting when making additional calls during sync

---

## 2026-01-18: US-36.1 - Settings Layout with Sidebar Navigation

### Summary
Created a new settings layout with sidebar navigation, breadcrumb, and placeholder sub-pages. The settings page now redirects to /settings/connections by default, with navigation to Connections, Thresholds, Users, and Display sections.

### Files Changed
- `frontend/src/routes/settings/+layout.svelte` - New layout with sidebar navigation and breadcrumb
- `frontend/src/routes/settings/+page.server.ts` - Server-side redirect to /settings/connections
- `frontend/src/routes/settings/+page.svelte` - Deleted (content will be extracted to sub-pages)
- `frontend/src/routes/settings/connections/+page.svelte` - Placeholder page for connections
- `frontend/src/routes/settings/thresholds/+page.svelte` - Placeholder page for thresholds
- `frontend/src/routes/settings/users/+page.svelte` - Placeholder page for users
- `frontend/src/routes/settings/display/+page.svelte` - Placeholder page for display
- `frontend/e2e/settings.spec.ts` - Updated E2E tests for new layout
- `frontend/e2e/auth-flow.spec.ts` - Updated to expect /settings/connections redirect
- `frontend/e2e/header.spec.ts` - Updated to expect /settings/connections redirect

### Key Implementation Details
- Layout uses flexbox with sidebar on left, content on right
- Breadcrumb shows: Dashboard > Settings > [Section Name]
- Active nav item highlighted with accent background color
- Server-side redirect using `throw redirect(307, '/settings/connections')`
- Responsive: @media (max-width: 768px) changes sidebar to horizontal scrollable tabs
- Icons for each nav item (plug, sliders, users, monitor) using inline SVG

### Verification
- 423 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings)
- 23 E2E tests pass
- Verified in browser: sidebar navigation works, redirect works, mobile responsive

### Learnings
- SvelteKit redirects must use `throw redirect()` not just `redirect()`
- New route directories require Docker rebuild to be picked up (HMR doesn't detect new folders)
- E2E tests that create users can hit rate limits when run in parallel

---

## 2026-01-18: US-36.2 - Extract Connections Page

### Summary
Extracted the API connections section from the deleted settings page into a dedicated `/settings/connections/+page.svelte` page. This is the first of four extraction stories (US-36.2 through US-36.5) to complete the settings page refactoring.

### Files Changed
- `frontend/src/routes/settings/connections/+page.svelte` - Full implementation of connections page
- `frontend/tests/settings-connections.test.ts` - New test file with 15 API contract tests

### Key Implementation Details
- All four service connection forms: Jellyfin, Jellyseerr, Radarr, Sonarr
- Each service has expand/collapse functionality with Edit/Cancel button
- Status indicators: green dot for connected, gray dot for not connected
- Domain extraction shows hostname instead of full URL (e.g., "jellyfin.example.com")
- Form shows "(leave blank to keep)" hint for API key when editing existing connection
- Auto-expand forms for unconfigured services (Jellyfin, Jellyseerr only)
- Auto-sync after first Jellyfin configuration if user has never synced
- Loading state with spinner during initial fetch
- Inline success/error messages for each form
- Responsive design: form fields stack vertically on mobile

### Verification
- 438 frontend unit tests pass (15 new tests)
- svelte-check passes (0 errors, 3 warnings)
- Verified in Docker: all connection forms load, expand, and display correctly
- Verified: status dots show correct colors based on configuration state

### Learnings
- The old settings page was deleted in US-36.1, but git history preserves the original code
- Code extraction from git history: `git show COMMIT^:path/to/file`
- Each settings sub-page manages its own state independently (no shared state between pages)

---

## 2026-01-18: US-36.3 - Extract Thresholds Page

### Summary
Extracted the analysis thresholds section from the deleted settings page into a dedicated `/settings/thresholds/+page.svelte` page. This is the second of four extraction stories to complete the settings page refactoring.

### Files Changed
- `frontend/src/routes/settings/thresholds/+page.svelte` - Full implementation of thresholds page
- `frontend/tests/settings-thresholds.test.ts` - New test file with 15 API contract tests

### Key Implementation Details
- Four threshold inputs: Old content months, Min age months, Large movie size, Large season size
- Help text shows which feature uses each threshold (e.g., "Used by: Old tab")
- Save button submits all values via POST /api/settings/analysis
- Reset button calls DELETE /api/settings/analysis to restore defaults
- Loading state with spinner during initial fetch
- Inline success/error messages
- Responsive: threshold rows stack vertically on mobile (≤600px)
- Default values: 4 months, 3 months, 13 GB, 15 GB

### Verification
- 453 frontend unit tests pass (15 new tests)
- svelte-check passes (0 errors, 3 warnings)
- Verified in Docker: page loads, Save works, Reset works
- Verified: changed value from 4 to 6, then Reset restored to 4

### Learnings
- Thresholds section already had a dedicated API endpoint (GET/POST/DELETE /api/settings/analysis)
- Old settings page was deleted in US-36.1; code extracted from git history
- Svelte 5 uses $state() for reactive state instead of let

---

## 2026-01-18: US-36.4 - Extract Users Page

### Summary
Extracted the user nicknames section from the deleted settings page into a dedicated `/settings/users/+page.svelte` page. This is the third of four extraction stories to complete the settings page refactoring.

### Files Changed
- `frontend/src/routes/settings/users/+page.svelte` - Full implementation of users/nicknames page
- `frontend/tests/settings-users.test.ts` - New test file with 16 API contract tests

### Key Implementation Details
- Table displays existing mappings: Jellyseerr Username → Display Name
- Warning badge (!) for users with `has_jellyseerr_account=false` (Jellyfin users not found in Jellyseerr)
- Edit mode: inline input field with Save/Cancel buttons
- Delete confirmation: inline "Delete this nickname?" with Confirm/Cancel buttons
- Empty state with "Add nickname" call-to-action button
- "Refresh users" button (only when Jellyfin configured) fetches Jellyfin users to populate list
- Toast feedback on all CRUD operations
- Responsive: table scrolls horizontally on mobile, header stacks vertically

### Verification
- 469 frontend unit tests pass (16 new tests)
- svelte-check passes (0 errors, 3 warnings)
- Verified in Docker: table loads, edit mode works, delete confirmation works
- Verified: warning badges display for users without Jellyseerr accounts

### Learnings
- Old settings page was deleted in US-36.1; code extracted from git history using `git show`
- The `has_jellyseerr_account` field was added in US-37.1 to mark users found in both Jellyfin and Jellyseerr
- Empty display names show "—" (em dash) instead of blank for visual clarity

---

## 2026-01-18: US-36.5 - Extract Display Page

### Summary
Extracted the display preferences section from the deleted settings page into a dedicated `/settings/display/+page.svelte` page. This is the final extraction story in the settings page refactoring series (US-36.1 through US-36.5).

### Files Changed
- `frontend/src/routes/settings/display/+page.svelte` - Full implementation of display settings page
- `frontend/tests/settings-display-page.test.ts` - New test file with 18 API contract tests

### Key Implementation Details
- Theme selector (Light/Dark/System) - changes apply immediately via theme store
- Title language dropdown (English/French) - saves on change
- Recently available days input (1-30 range) - saves on change
- Show unreleased requests toggle - saves on change
- Each setting calls POST /api/settings/display with a partial update (single field)
- Loading state with spinner during initial fetch
- Saving indicator shows when any setting is being saved
- Responsive: setting rows stack vertically on mobile (≤600px)

### Verification
- 487 frontend unit tests pass (18 new tests)
- svelte-check passes (0 errors, 3 warnings - all pre-existing)
- Verified in Docker: all display settings load, change, and persist correctly
- Theme changes apply immediately to the UI

### Learnings
- The old settings page was deleted in US-36.1; this completes the extraction series
- Using partial updates (one field per POST) simplifies the save logic and provides instant feedback
- The theme store already had `setPreference()` method to apply theme changes to the DOM

---

## 2026-01-18: US-39.1 - Add Manual Dismiss Button to Toasts

### Summary
Added manual dismiss button to all toast notifications with keyboard accessibility and ARIA labels.

### Files Changed
- `frontend/src/lib/components/Toast.svelte` - New reusable Toast component with close button
- `frontend/tests/toast.test.ts` - 28 new unit tests for Toast component
- `frontend/src/routes/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/issues/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/whitelist/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/info/recent/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/content/old-unwatched/+page.svelte` - Updated to use Toast component

### Key Implementation Details
- Toast.svelte component with X close button in top-right corner
- Keyboard accessible: Tab to focus, Enter/Space to activate close
- aria-label="Close notification" for screen reader accessibility
- SVG X icon with aria-hidden="true" (decorative)
- Close button has hover/focus styles for visual feedback
- Each page tracks toastTimer to clear on manual close
- Auto-dismiss after 3 seconds still works if not manually closed
- Supports success, error, and info toast types

### Verification
- 521 frontend unit tests pass (28 new tests)
- svelte-check passes (0 errors, 3 warnings - all pre-existing)
- Docker build succeeds
- Toast component renders correctly in browser

---

## Notes

- US-0.2 (Dockerize) was completed together with US-0.1 since Docker setup was needed for testing
- Backend runs on port 8080 (mapped from 8000), Frontend on port 5173
- API proxy configured in vite.config.ts for dev environment
- Production: https://mediajanitor.com with HTTPS via Let's Encrypt
- CI/CD: Push to main triggers auto-deploy to VPS

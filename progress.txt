# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: Epic 37 - Nickname Prefill (In Progress)
**Total Stories**: 42 stories (40 passes: true, 2 remaining)

---

## 2026-01-16: US-37.1 - Prefill Nicknames During Sync (Backend)

### Summary
Implemented automatic prefill of nickname records for all Jellyfin users during sync, including detection of users with Jellyseerr accounts.

### Files Changed
- `backend/app/database.py` - Added `has_jellyseerr_account` boolean field to `UserNickname` model
- `backend/app/models/settings.py` - Added `has_jellyseerr_account` to `NicknameItem` response model
- `backend/app/services/sync.py` - Added `fetch_jellyseerr_users()` and `prefill_user_nicknames()` functions
- `backend/app/services/nicknames.py` - Updated to include `has_jellyseerr_account` in list response
- `backend/app/routers/settings.py` - Updated nickname endpoints to return `has_jellyseerr_account`
- `backend/tests/test_nickname_prefill.py` - New test file for nickname prefill functionality
- `backend/tests/test_sync.py` - Updated existing tests to mock new functions
- `backend/tests/test_sync_mocked_integration.py` - Added Jellyseerr users mock
- `backend/alembic/versions/20260116_184830_*.py` - Migration for `has_jellyseerr_account` column

### Key Implementation Details
- `fetch_jellyseerr_users()` calls `/api/v1/user` endpoint and returns empty list on error (graceful degradation)
- `prefill_user_nicknames()` creates nickname records for each Jellyfin user during sync
  - Preserves existing mappings (only creates if not exists)
  - Matches Jellyfin usernames against Jellyseerr users (case-insensitive)
  - Sets `has_jellyseerr_account=True` for users found in Jellyseerr
- Display name is left empty for user to fill in later

### Learnings
- When adding new API calls to sync service, remember to update all existing sync tests to mock the new functions
- `respx` mocks require explicit routes for every HTTP call made during test

---

## Notes

- US-0.2 (Dockerize) was completed together with US-0.1 since Docker setup was needed for testing
- Backend runs on port 8080 (mapped from 8000), Frontend on port 5173
- API proxy configured in vite.config.ts for dev environment
- Production: https://mediajanitor.com with HTTPS via Let's Encrypt
- CI/CD: Push to main triggers auto-deploy to VPS

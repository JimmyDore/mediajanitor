# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Completed Tasks

### 2026-01-12: US-0.1 - Hello World (Full Stack)
- Created project structure with FastAPI backend and SvelteKit frontend
- Implemented GET /api/hello endpoint (TDD: test first, then implementation)
- Frontend fetches and displays "Hello World" from backend
- Docker setup: Dockerfiles + docker-compose.yml
- Verified full stack communication with docker-compose up
- Commits:
  - feat(api): add hello world endpoint
  - feat(ui): display hello message from backend
  - chore(docker): add Docker setup for full stack

### 2026-01-12: US-0.3 - Deploy to VPS
- Configured DNS for mediajanitor.com (A record pointing to 194.32.76.43)
- Deployed app to VPS at ~/mediajanitor
- Configured nginx reverse proxy with SSL (certbot)
- Set up GitHub Actions CI/CD workflow
- Configured GitHub secrets (VPS_HOST, VPS_USERNAME, VPS_SSH_KEY)
- App accessible at https://mediajanitor.com
- Commits:
  - chore: add allowedHosts for production domain
  - chore: configure GitHub Actions for auto-deploy

### 2026-01-12: US-1.1 - User Registration
- Created User model with SQLAlchemy (email, hashed_password, timestamps)
- Implemented POST /api/auth/register endpoint with validation
- Password hashing using bcrypt
- Registration form at /register with email/password fields
- Client-side password validation (min 8 characters)
- Error handling for duplicate emails and validation errors
- Redirect to login page after successful registration
- Backend tests: 7 new tests for registration endpoint
- Frontend tests: 6 new tests for API integration and validation
- Migrated from passlib to bcrypt directly (compatibility fix)
- Converted project to use uv package manager
- Commits:
  - feat(auth): add user registration endpoint with password hashing
  - feat(ui): add registration form page

### 2026-01-12: US-1.2 - User Login
- Implemented POST /api/auth/login endpoint with JWT token generation
- Added python-jose[cryptography] for JWT support
- Added secret_key and access_token_expire_minutes settings
- Login validates credentials and returns JWT access_token with bearer type
- Created login form at /login with email/password fields
- Token stored in localStorage after successful login
- Redirect to dashboard after successful login
- Backend tests: 6 new tests for login endpoint
- Frontend tests: 4 new tests for login API integration
- E2E tests: 5 new tests for login page UI
- Verified in Docker: register + login flow works correctly
- Commits:
  - feat(auth): add user login endpoint with JWT

### 2026-01-12: US-1.3 - Protected Routes
- Implemented `get_current_user` dependency for JWT token validation
- Added `/api/auth/me` endpoint to return current user info
- Created OAuth2PasswordBearer scheme for token extraction
- Frontend auth store with checkAuth(), logout(), setUser() methods
- Layout redirects unauthenticated users to /login (public routes: /login, /register)
- Login page updates auth state and redirects to dashboard
- Dashboard shows user email and logout button when authenticated
- Backend tests: 6 new tests for protected endpoint scenarios
- E2E tests: 4 new tests for protected routes behavior
- Verified in Docker: full auth flow (register -> login -> /me -> logout)
- Commits:
  - feat(auth): add protected routes with JWT validation

### 2026-01-12: US-2.1 - Configure Jellyfin Connection
- Created UserSettings model in database.py with per-user encrypted credentials
- Implemented Fernet encryption for API keys (app/services/encryption.py)
- Created Jellyfin service (app/services/jellyfin.py) with:
  - validate_jellyfin_connection() - Tests connection to Jellyfin server
  - save_jellyfin_settings() - Saves encrypted credentials to DB
  - get_user_jellyfin_settings() - Retrieves user's settings
- Created settings router (app/routers/settings.py) with:
  - POST /api/settings/jellyfin - Save settings after validation
  - GET /api/settings/jellyfin - Get current settings (masked API key)
- Created settings page at /settings with:
  - Form for Jellyfin URL and API key
  - Status badge showing connection state
  - Success/error feedback messages
  - Back to dashboard link
- Added Settings link to dashboard page
- Backend tests: 9 new tests for settings endpoints
- E2E tests: 7 new tests for settings page UI
- Verified in Docker: API endpoints work correctly
- Commits:
  - feat(settings): add Jellyfin connection configuration

### 2026-01-12: US-2.1.5 - Backend Cleanup
- Deleted unused Pydantic models: content.py, jellyseerr.py, whitelist.py
- Updated models/__init__.py to only export user.py and settings.py models
- Removed premature SQLAlchemy tables from database.py:
  - WhitelistContent, WhitelistFrenchOnly, WhitelistFrenchSubsOnly
  - WhitelistLanguageExempt, WhitelistEpisodeExempt, AppSettings
- Removed unused 'relationship' import from database.py
- Added types-python-jose to dev dependencies for mypy compatibility
- Files changed: database.py, models/__init__.py, pyproject.toml
- Commits:
  - chore(backend): [US-2.1.5] remove premature code

### 2026-01-12: US-2.2 - Configure Jellyseerr Connection
- Created Jellyseerr service (app/services/jellyseerr.py) with:
  - validate_jellyseerr_connection() - Tests connection to Jellyseerr /api/v1/status
  - save_jellyseerr_settings() - Saves encrypted credentials to DB
  - get_user_jellyseerr_settings() - Retrieves user's settings
  - get_decrypted_jellyseerr_api_key() - Decrypts stored API key
- Extended settings router with Jellyseerr endpoints:
  - POST /api/settings/jellyseerr - Save settings after validation
  - GET /api/settings/jellyseerr - Get current settings (masked API key)
- Added Jellyseerr Pydantic models (JellyseerrSettingsCreate, JellyseerrSettingsResponse)
- Extended settings page with Jellyseerr section below Jellyfin:
  - Form for Jellyseerr URL and API key
  - Status badge showing connection state
  - Success/error feedback messages
- Backend tests: 9 new tests for Jellyseerr settings endpoints
- Frontend tests: 8 new tests for Jellyseerr API integration
- Verified in Docker: API endpoints and UI work correctly
- Files changed: settings.py, models/settings.py, routers/settings.py, +page.svelte
- Commits:
  - feat(settings): [US-2.2] add Jellyseerr connection configuration

### 2026-01-12: US-2.3 - Navigation Header
- Created Header component (frontend/src/lib/components/Header.svelte) with:
  - Logo/app name ("Media Janitor") linking to home
  - Dashboard and Settings navigation links
  - Logout button
  - Active state highlighting for current page
- Updated layout (+layout.svelte) to:
  - Show header only on authenticated routes
  - Hide header on public routes (/login, /register)
  - Adjust layout for full-width content with header
- Refactored dashboard page:
  - Removed redundant user-info section (logout, settings link)
  - Added simple welcome message
  - Updated page title to "Dashboard - Media Janitor"
- Refactored settings page:
  - Removed back button and local header
  - Updated page title to "Settings - Media Janitor"
  - Added page description text
- E2E tests: 13 new tests for header functionality
  - Tests header visibility on auth/non-auth pages
  - Tests navigation link functionality
  - Tests active state highlighting
- Removed obsolete "back to dashboard" test from settings.spec.ts
- Files changed: Header.svelte, +layout.svelte, +page.svelte, settings/+page.svelte
- Commits:
  - feat(ui): [US-2.3] add navigation header component

### 2026-01-12: US-7.1 - Automatic Daily Data Sync
- Created database cache models in database.py:
  - CachedMediaItem: stores Jellyfin movies/series with all metadata
  - CachedJellyseerrRequest: stores Jellyseerr requests
  - SyncStatus: tracks last sync timestamp and status per user
- Created sync service (app/services/sync.py) with:
  - fetch_jellyfin_media(): Fetches all movies/series from Jellyfin API
  - fetch_jellyseerr_requests(): Fetches all requests with pagination
  - cache_media_items(): Stores fetched data in DB, replacing old cache
  - cache_jellyseerr_requests(): Stores requests in DB
  - run_user_sync(): Orchestrates full sync for a user
  - get_sync_status(): Returns last sync info for dashboard display
- Created sync router (app/routers/sync.py) with:
  - POST /api/sync: Triggers sync for authenticated user
  - GET /api/sync/status: Returns last sync timestamp and counts
- Updated dashboard to display "Last synced" timestamp
- Backend tests: 11 new tests for sync functionality
- Verified in Docker: endpoints work correctly
- Files changed: database.py, services/sync.py, routers/sync.py, main.py, +page.svelte
- Commits:
  - feat(sync): [US-7.1] add data sync service and endpoints

### 2026-01-12: US-7.2 - Manual Data Refresh
- Added rate limiting to sync endpoint (1 refresh per 5 minutes per user):
  - Modified routers/sync.py to check last_sync_started timestamp
  - Returns 429 with "Rate limited. Please wait X minute(s)" message
- Added Refresh button to dashboard:
  - Button shows loading spinner with "Syncing..." text during sync
  - Toast notifications for success, rate limit, or error messages
  - Button disabled during sync to prevent double-clicks
- Dashboard updates sync status after successful refresh
- Backend tests: 4 new tests for rate limiting functionality
- Frontend tests: 9 new tests for sync API integration
- E2E tests: 8 new tests for refresh button UI
- Verified in browser: refresh button works, rate limiting enforced
- Files changed: routers/sync.py, +page.svelte, tests/test_sync.py, tests/sync.test.ts, e2e/sync.spec.ts
- Commits:
  - feat(sync): [US-7.2] add manual data refresh with rate limiting

### 2026-01-12: US-7.1.5 - Local Integration Test for Sync
- Manual integration test verifying sync service with real APIs
- Test steps executed:
  1. Started docker-compose locally
  2. Logged in with test credentials (jimmy291295+2@gmail.com)
  3. Configured Jellyfin connection: https://jimmydore.eclipse.usbx.me/jellyfin
  4. Configured Jellyseerr connection: https://jellyseerr-jimmydore.eclipse.usbx.me/
  5. Triggered sync via UI Refresh button
  6. Verified sync completed successfully
- Results:
  - 324 media items synced from Jellyfin
  - 244 requests synced from Jellyseerr
  - Last synced timestamp displayed on dashboard
  - /api/sync/status returns correct counts
- All acceptance criteria verified successfully
- No issues found during integration testing

### 2026-01-13: US-3.1 - View Old Unwatched Content
- Created ContentWhitelist database model for future whitelist functionality
- Created content service (app/services/content.py) with:
  - is_old_or_unwatched(): Filters items by watch status and age
  - get_old_unwatched_content(): Returns filtered, sorted content list
  - format_size(): Human-readable size formatting
  - parse_jellyfin_datetime(): Date parsing for comparison
- Created content router (app/routers/content.py) with:
  - GET /api/content/old-unwatched: Returns old/unwatched content for user
- Created Pydantic models (app/models/content.py):
  - OldUnwatchedItem: Single content item response
  - OldUnwatchedResponse: Full response with items and totals
- Created frontend page at /content/old-unwatched with:
  - Page title and description
  - Summary bar showing total count and size
  - Content list with columns: #, name, type, year, size, last watched
  - Type badges (Movie/Series) with color coding
  - "Never watched" status highlighted
  - Loading and error states
  - Responsive design
- Added "Old Content" navigation link to header
- Backend tests: 10 new tests for content endpoint
- Frontend tests: 7 new tests for API integration
- E2E tests: 10 new tests for UI (some timeouts - route mocking issues)
- Verified in Docker: 221 items totaling 741.3 GB displayed correctly
- Files changed: database.py, services/content.py, routers/content.py, models/content.py, main.py, Header.svelte, +page.svelte
- Commits:
  - feat(content): [US-3.1] add old/unwatched content view

### 2026-01-13: US-3.2 - Protect Content from Deletion
- Created whitelist router (app/routers/whitelist.py) with:
  - POST /api/whitelist/content: Add content to user's whitelist
  - Returns 201 with success message on add
  - Returns 409 Conflict if already in whitelist
  - Requires authentication (user_id from JWT)
- Extended content service (app/services/content.py) with:
  - add_to_whitelist(): Creates whitelist entry, checks for duplicates
- Extended content models (app/models/content.py) with:
  - WhitelistAddRequest: Request model for adding to whitelist
  - WhitelistAddResponse: Response model with success message
- Updated old-unwatched frontend page with:
  - "Protect" button in Actions column for each item
  - Clicking button calls POST /api/whitelist/content
  - Item immediately removed from list on success
  - Total count and size update after protection
  - Toast notification showing "Added to whitelist" or error message
  - Button shows loading spinner during API call
  - Button disabled while processing
- Backend tests: 7 new tests for whitelist endpoint
- Frontend tests: 5 new tests for whitelist API integration
- E2E tests: 7 new tests for Protect button functionality
- Verified in Docker: Protected "Spider-Man: Across the Spider-Verse", count dropped 221→220, size dropped 741.3→728.9 GB
- Files changed: routers/whitelist.py, services/content.py, models/content.py, main.py, +page.svelte, test_content.py, old-unwatched.test.ts, old-unwatched.spec.ts
- Commits:
  - feat(content): [US-3.2] add protect content from deletion

### 2026-01-13: US-3.3 - Manage Content Whitelist
- Extended whitelist router (app/routers/whitelist.py) with:
  - GET /api/whitelist/content: List all items in user's whitelist
  - DELETE /api/whitelist/content/{id}: Remove item from whitelist by ID
  - Returns 404 if item not found or belongs to another user
- Extended content service (app/services/content.py) with:
  - get_whitelist(): Returns all whitelist entries for user
  - remove_from_whitelist(): Deletes entry by ID with user validation
- Extended content models (app/models/content.py) with:
  - WhitelistItem: Single whitelist item response
  - WhitelistListResponse: Response with items array and count
  - WhitelistRemoveResponse: Success message for deletion
- Created whitelist frontend page at /whitelist with:
  - Page title "Protected Content" and description
  - Summary bar showing total protected items count
  - Content list with columns: name, type, date added, actions
  - Type badges (Movie/Series) with color coding
  - "Remove" button to unprotect items
  - Empty state with link to Old Content page
  - Toast notifications for success/error
  - Loading and error states
  - Responsive design
- Added "Whitelist" navigation link to header
- Backend tests: 10 new tests for GET and DELETE endpoints
- Frontend tests: 10 new tests for whitelist API integration
- E2E tests: 14 tests for whitelist page UI
- Verified in Docker:
  - Added item via Protect button (221→220 items)
  - Whitelist shows item with Remove button
  - Remove button deletes item
  - Item reappears in old content list (220→221 items)
- Files changed: routers/whitelist.py, services/content.py, models/content.py, Header.svelte, +page.svelte, test_content.py, whitelist.test.ts, whitelist.spec.ts
- Commits:
  - feat(content): [US-3.3] add manage content whitelist

## Current Status

**Phase**: Epic 4 - Large Movies (In Progress)
**Next US**: US-4.1 - View Large Movies

## Notes

- US-0.2 (Dockerize) was completed together with US-0.1 since Docker setup was needed for testing
- Backend runs on port 8080 (mapped from 8000), Frontend on port 5173
- API proxy configured in vite.config.ts for dev environment
- Production: https://mediajanitor.com with HTTPS via Let's Encrypt
- CI/CD: Push to main triggers auto-deploy to VPS

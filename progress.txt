# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: All epics complete - ready for new features
**Total Stories**: 191 stories completed (see ARCHIVED_PRD.md)

---

## Completed Tasks

Task logs archived to ARCHIVED_PROGRESS.txt on 2026-01-19.

### 2026-01-22

**US-48.1: Ultra API Settings - Backend**
- Added `ultra_api_url` and `ultra_api_key_encrypted` columns to UserSettings model
- Created Alembic migration `30dd116f11f8_add_ultra_api_settings_to_user_settings`
- Created `app/services/ultra.py` with save/get functions (following Radarr/Sonarr pattern)
- Added Pydantic models: `UltraSettingsCreate`, `UltraSettingsResponse`
- Added POST/GET `/api/settings/ultra` endpoints
- Files changed: `database.py`, `models/settings.py`, `routers/settings.py`, `services/ultra.py`, migration file
- 8 unit tests added (all pass), verified in Docker

**US-48.3: Ultra Warning Thresholds - Settings**
- Added `ultra_storage_warning_gb` and `ultra_traffic_warning_percent` columns to UserSettings model
- Created Alembic migration `26a3b23ff8ca_add_ultra_warning_thresholds_to_user_settings`
- Added Pydantic models: `UltraThresholdsCreate`, `UltraThresholdsResponse`
- Added POST/GET `/api/settings/ultra/thresholds` endpoints with defaults (100 GB, 20%)
- Added Seedbox Monitoring section to Settings/Connections page with Ultra.cc connection and Warning Thresholds
- Files changed: `database.py`, `models/settings.py`, `routers/settings.py`, `connections/+page.svelte`, migration file
- 12 backend tests + 14 frontend tests added (all pass), verified in Docker and browser

**US-48.4: Fetch Ultra Stats During Sync**
- Added `fetch_ultra_stats(url, api_key)` function to `services/ultra.py` with Bearer token auth
- Added `ultra_free_storage_gb`, `ultra_traffic_available_percent`, `ultra_last_synced_at` columns to UserSettings
- Created Alembic migration `54b0e03433c5_add_ultra_stats_columns_to_user_settings`
- Integrated Ultra API call into `run_user_sync()` as non-blocking call after Jellyseerr sync
- Sync succeeds even if Ultra API fails (logs warning and continues)
- Files changed: `database.py`, `services/sync.py`, `services/ultra.py`, migration file, `tests/test_ultra_service.py`
- 9 unit tests added for fetch_ultra_stats (all pass), 607 total tests pass, verified in Docker

**US-49.1: Delete Movies from Cache After Deletion**
- Added `_delete_cached_media_by_tmdb_id()` helper function to delete CachedMediaItem by TMDB ID in raw_data.ProviderIds.Tmdb
- Added `_delete_cached_jellyseerr_request_by_tmdb_id()` helper function to delete matching CachedJellyseerrRequest by TMDB ID
- Integrated cache deletion into `delete_movie` endpoint after successful Radarr deletion
- Cache deletion happens AFTER Jellyseerr API lookup but before response (order matters)
- If Radarr deletion fails, cache is NOT deleted (items stay in list)
- Files changed: `routers/content.py`, `tests/test_delete_content.py`
- 4 new unit tests added (611 total tests pass), mypy passes, verified in Docker with integration tests

**US-49.2: Delete Series from Cache After Deletion**
- Reused existing `_delete_cached_media_by_tmdb_id()` and `_delete_cached_jellyseerr_request_by_tmdb_id()` helper functions
- Integrated cache deletion into `delete_series` endpoint after successful Sonarr deletion
- Cache deletion happens AFTER Jellyseerr API lookup but before response (same pattern as US-49.1)
- If Sonarr deletion fails, cache is NOT deleted (items stay in list)
- If Sonarr succeeds but Jellyseerr fails, cache is still deleted
- Files changed: `routers/content.py`, `tests/test_delete_content.py`
- 4 new unit tests added (615 total tests pass), mypy passes, verified in Docker with integration tests

**US-49.3: Delete Requests from Cache After Deletion**
- Added `_delete_cached_jellyseerr_request_by_id()` helper function to delete CachedJellyseerrRequest by Jellyseerr ID
- Integrated cache deletion into `delete_request_endpoint` after successful Jellyseerr media deletion
- If Jellyseerr deletion fails, cache is NOT deleted (request stays in list)
- Files changed: `routers/content.py`, `tests/test_delete_content.py`
- 2 new unit tests added (617 total tests pass), mypy passes, verified in Docker with integration tests

### 2026-01-23

**US-51.1: Fetch Episode Details During Sync**
- Added `fetch_jellyseerr_season_episodes(client, server_url, api_key, tmdb_id, season_number)` function to `sync.py`
- Function calls Jellyseerr `GET /api/v1/tv/{tmdb_id}/season/{season_number}` endpoint with X-Api-Key auth
- Returns list of `{episodeNumber, name, airDate}` dicts, empty list on error (graceful failure)
- Integrated into `fetch_jellyseerr_requests()` for status 4 TV shows
- Skips specials (season 0) when fetching episodes
- Episodes stored in `raw_data.media.seasons[].episodes` array
- Files changed: `app/services/sync.py`, `tests/test_sync.py`
- 13 new unit tests added (634 total tests pass), mypy passes, verified in Docker with integration tests

**US-51.2: Include Ongoing Series in Recently Available**
- Added `_get_recent_episodes_from_cached_data(request, days_back)` helper function in `content.py`
- Function checks `raw_data.media.seasons[].episodes[].airDate` for episodes within `days_back` window
- Returns `{season_num: [episode_nums]}` dict if recent episodes found, None otherwise
- Modified `get_recently_available()` to check for recent episodes on status 4 TV shows
- Modified `get_recently_available_count()` with same logic for dashboard summary consistency
- If recent episodes found, uses today's date as `availability_date` to force inclusion
- Series appears once (not per episode) in the list
- Files changed: `app/services/content.py`, `tests/test_content.py`
- 13 new unit tests added (647 total tests pass), mypy passes, verified in Docker with integration tests

**US-51.3: API Response with Season/Episode Details**
- Added optional fields to `RecentlyAvailableItem` model: `season_info`, `episode_count`, `available_episodes`, `total_episodes`
- Added `_get_season_episode_details(request)` helper function to extract season/episode info from raw_data
- Added `_format_season_info(season_numbers)` helper to format season list ("Seasons 1-3", "Seasons 1, 3, 4", etc.)
- Status 5 TV shows: `season_info` = "Season X" or "Seasons X-Y", `episode_count` = total episodes
- Status 4 TV shows: `season_info` = "Season X in progress", `available_episodes`/`total_episodes` for progress
- Movies: all fields return `None`
- Specials (season 0) excluded from season_info display but included in episode count
- Files changed: `app/models/content.py`, `app/services/content.py`, `tests/test_content.py`
- 8 new unit tests added (655 total tests pass), mypy passes, verified in Docker with integration tests

**US-48.2: Ultra API Settings - Frontend**
- Added `frontend/tests/settings-ultra.test.ts` with 12 API integration tests
- Tests cover GET/POST /api/settings/ultra endpoints for authentication, validation, and UI behavior
- UI implementation was already completed in US-48.3 (Seedbox Monitoring section)
- Verified in browser: Connected badge, masked token placeholder, form fields all working
- Files changed: `frontend/tests/settings-ultra.test.ts`
- 12 new unit tests added (701 total frontend tests pass), typecheck passes

**US-48.5: Display Ultra Stats on Dashboard**
- Updated `UltraSettingsResponse` model to include: `free_storage_gb`, `traffic_available_percent`, `last_synced_at`, `storage_warning_gb`, `traffic_warning_percent`
- Updated GET `/api/settings/ultra` endpoint to return cached stats and warning thresholds
- Added `Seedbox Status` card to Dashboard above Issues section with:
  - Free Storage (GB) and Traffic Available (%) display
  - Last synced timestamp
  - Warning colors: yellow when below threshold, red when below 50% of threshold
- Card hidden when Ultra not configured or no stats available (free_storage_gb is null)
- Files changed: `backend/app/models/settings.py`, `backend/app/routers/settings.py`, `frontend/src/routes/+page.svelte`, `backend/tests/test_settings.py`, `frontend/tests/dashboard-seedbox.test.ts`
- 3 new backend unit tests (661 total pass), 17 new frontend tests (718 total pass), mypy passes, typecheck passes
- Verified in Docker: API returns stats fields, card properly hidden when no stats, warning colors implemented

---

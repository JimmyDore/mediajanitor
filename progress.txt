# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: All epics complete - ready for new features
**Total Stories**: 209 stories completed (see ARCHIVED_PRD.md)

---

## Completed Tasks

Task logs archived to ARCHIVED_PROGRESS.txt on 2026-01-23.

### 2026-01-24

**US-57.1: Split content.py into focused modules**
- Created `backend/app/services/whitelist.py` (558 lines)
  - All whitelist CRUD operations for 6 whitelist types
- Created `backend/app/services/content_analysis.py` (423 lines)
  - Analysis functions: is_old_or_unwatched, is_large_movie, has_language_issues, etc.
  - Constants, types, and utility functions
- Created `backend/app/services/content_queries.py` (880 lines)
  - Query functions: get_content_summary, get_content_issues, get_library
  - Recently available, unavailable requests, season/episode helpers
- Updated `backend/app/services/content.py` (197 lines)
  - Now a thin facade that re-exports all functions for backwards compatibility
- All 694 tests pass, mypy clean, no API changes

**US-57.2: Extract generic whitelist service base class**
- Created `backend/app/services/whitelist_base.py` (~260 lines)
  - BaseJellyfinIdWhitelistService for ContentWhitelist, FrenchOnly, LanguageExempt, Large
  - BaseJellyseerrIdWhitelistService for JellyseerrRequest
  - Generic CRUD: add(), get_list(), remove(), get_ids()
- Refactored `backend/app/services/whitelist.py` (from 748 to ~330 lines)
  - Service classes delegate to base classes
  - EpisodeLanguageExempt kept as-is (different field structure)
- Fixed test imports for _get_recent_episodes_from_cached_data
- All 657 tests pass, mypy clean, no API changes

**US-57.3: Consolidate whitelist router endpoints**
- Refactored `backend/app/routers/whitelist.py` (from 516 to 435 lines, ~16% reduction)
  - Created `create_jellyfin_whitelist_routes()` endpoint factory function
  - Generates GET/POST/DELETE for 4 jellyfin-id-based whitelists (content, french-only, language-exempt, large)
  - Requests endpoint kept separate (has special TMDB title lookup logic)
  - Episode-exempt endpoint kept separate (different field structure)
- All 6 whitelist types maintain exact same API contracts (URLs, request/response models)
- OpenAPI schema documents all 18 endpoints properly
- All 694 tests pass, mypy clean, Docker verified

**US-57.4: Move business logic from content router to services**
- Created `backend/app/services/content_cache.py` (~140 lines)
  - get_user_settings: Get user settings from database
  - lookup_jellyseerr_media_by_tmdb: Look up Jellyseerr media ID by TMDB ID
  - lookup_jellyseerr_media_by_request_id: Look up media ID by request ID
  - delete_cached_media_by_tmdb_id: Delete cached media by TMDB ID
  - delete_cached_jellyseerr_request_by_tmdb_id: Delete cached request by TMDB
  - delete_cached_jellyseerr_request_by_id: Delete cached request by ID
- Updated `backend/app/services/content.py` to re-export cache functions
- Refactored `backend/app/routers/content.py` (from 528 to 403 lines, ~24% reduction)
  - Router now only handles HTTP concerns
  - All business logic moved to services
- All 694 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-59.1: Parallelize content summary queries**
- Updated `backend/app/services/content_queries.py` `get_content_summary()` function
  - Used `asyncio.gather()` to parallelize 5 independent whitelist queries:
    - `get_large_whitelist_ids(db, user_id)`
    - `get_french_only_ids(db, user_id)`
    - `get_language_exempt_ids(db, user_id)`
    - `get_unavailable_requests_count(db, user_id)`
    - `get_recently_available_count(db, user_id)`
  - These queries were previously called sequentially, now run in parallel
- Added tests in `TestContentSummaryParallelization` class to verify whitelist handling
- All 696 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-59.2: Parallelize content issues queries**
- Updated `backend/app/services/content_queries.py` `get_content_issues()` function
  - Used `asyncio.gather()` to parallelize 5 independent queries:
    - `get_user_thresholds(db, user_id)`
    - `_get_user_settings(db, user_id)` (new helper function)
    - `get_french_only_ids(db, user_id)`
    - `get_language_exempt_ids(db, user_id)`
    - `get_large_whitelist_ids(db, user_id)`
  - Sonarr slug map fetch runs after (depends on user_settings result)
- Added `_get_user_settings()` helper function for async user settings retrieval
- All 696 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-59.4: Optimize sync season size calculation**
- Optimized `backend/app/services/sync.py` `calculate_season_sizes()` function
  - Added `fetch_series_episodes()`: Fetches all episodes for a series in one call (vs per-season)
  - Added `check_episodes_languages()`: Inline language check on already-fetched episodes (vs separate API calls)
  - Refactored `calculate_season_sizes()`:
    - Fetch seasons ONCE per series (reused for size + language check)
    - Fetch episodes ONCE per season (reused for size + language + watch data base)
    - Batch user watch data at series level: 1 call per user per series (not per season)
  - API call reduction: From (2 + 2N + N×U) to (1 + N + U) per series
    - Example with 5 seasons, 15 users: 87 calls → 21 calls (76% reduction)
- Added test `test_calculate_season_sizes_optimized_api_calls` to verify optimization
- All 697 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-60.1: Add content router tests**
- Created `backend/tests/test_content_cache_service.py` with 21 tests covering:
  - `TestGetUserSettings`: 3 tests for get_user_settings() function
  - `TestLookupJellyseerrMediaByTmdb`: 4 tests for lookup by TMDB ID and media type
  - `TestLookupJellyseerrMediaByRequestId`: 3 tests for lookup by Jellyseerr request ID
  - `TestDeleteCachedMediaByTmdbId`: 5 tests for delete with TMDB ID filtering
  - `TestDeleteCachedJellyseerrRequestByTmdbId`: 3 tests for delete requests by TMDB
  - `TestDeleteCachedJellyseerrRequestById`: 3 tests for delete requests by ID
- All tests verify user isolation (user_id filtering) and edge cases
- Coverage: content.py (facade) 100%, content_cache.py 100%
- Note: Functions were moved from router to service in US-57.4
- All 718 tests pass, mypy clean

**US-60.2: Add auth router tests**
- Added `TestGetClientIp` class to `backend/tests/test_auth.py` with 6 tests:
  - test_get_client_ip_from_x_forwarded_for_single_ip: Single IP extraction
  - test_get_client_ip_from_x_forwarded_for_multiple_ips: Multiple IPs (picks first client IP)
  - test_get_client_ip_from_x_forwarded_for_with_whitespace: Whitespace stripping
  - test_get_client_ip_fallback_to_client_host: Fallback when X-Forwarded-For missing
  - test_get_client_ip_unknown_when_no_client: Returns "unknown" when client is None
  - test_get_client_ip_x_forwarded_for_takes_precedence: XFF takes precedence over client.host
- Added `TestChangePassword` class with 6 tests:
  - test_change_password_success: Full flow - change password, verify old fails, new works
  - test_change_password_wrong_current_password: Returns 400 with error message
  - test_change_password_requires_authentication: Returns 401 without token
  - test_change_password_weak_new_password: Returns 422 for short password
  - test_change_password_missing_current_password: Returns 422
  - test_change_password_missing_new_password: Returns 422
- Existing tests already cover: send_signup_notification (5 tests), send_blocked_signup_notification (2 tests), signup disabled flow (4 tests)
- All 730 tests pass (728 unit + 2 integration skipped without Docker), mypy clean

**US-60.3: Add jellyfin service tests**
- Created `backend/tests/test_jellyfin_service.py` with 24 tests covering all 4 functions:
  - `TestValidateJellyfinConnection` (11 tests):
    - test_returns_true_on_200_success: Success path verification
    - test_uses_system_info_endpoint: Correct /System/Info endpoint called
    - test_sends_api_key_header: X-Emby-Token header sent correctly
    - test_normalizes_trailing_slash: URL normalization (no double slashes)
    - test_returns_false_on_401_unauthorized: Invalid API key handling
    - test_returns_false_on_403_forbidden: Access denied handling
    - test_returns_false_on_404_not_found: Wrong URL handling
    - test_returns_false_on_500_server_error: Server error handling
    - test_returns_false_on_timeout: Timeout exception handling
    - test_returns_false_on_connection_error: Connection refused handling
    - test_returns_false_on_dns_error: DNS failure handling
  - `TestGetUserJellyfinSettings` (3 tests): None when no settings, returns settings, user isolation
  - `TestSaveJellyfinSettings` (5 tests): Create new, update existing, trailing slash, encryption, user isolation
  - `TestGetDecryptedJellyfinApiKey` (5 tests): None key, decryption, empty string, special chars, unicode
- Coverage: jellyfin.py 100% (31/31 statements)
- All 754 tests pass, mypy clean

**US-60.4: Add nicknames service tests**
- Created `backend/tests/test_nicknames_service.py` with 17 tests covering all 4 functions:
  - `TestCreateNickname` (4 tests):
    - test_creates_nickname_successfully: Success path verification
    - test_raises_valueerror_on_duplicate: Duplicate detection raises ValueError
    - test_allows_same_username_for_different_users: User isolation verification
    - test_nickname_created_at_is_set: Timestamp automatically set
  - `TestGetNicknames` (5 tests):
    - test_returns_empty_list_for_user_with_no_nicknames: Empty list handling
    - test_returns_nicknames_ordered_alphabetically: Ordering by jellyseerr_username
    - test_returns_only_user_specific_nicknames: User isolation verification
    - test_returns_nickname_item_with_all_fields: All NicknameItem fields present
    - test_created_at_is_formatted_as_iso_string: ISO format datetime string
  - `TestUpdateNickname` (4 tests):
    - test_updates_nickname_successfully: Success path returns True
    - test_returns_false_when_nickname_not_found: Non-existent ID returns False
    - test_returns_false_when_nickname_belongs_to_other_user: User isolation
    - test_preserves_other_fields_when_updating: Only display_name changes
  - `TestDeleteNickname` (4 tests):
    - test_deletes_nickname_successfully: Success path returns True
    - test_returns_false_when_nickname_not_found: Non-existent ID returns False
    - test_returns_false_when_nickname_belongs_to_other_user: User isolation
    - test_does_not_affect_other_users_nicknames: Only deletes specified item
- Coverage: nicknames.py 100% (all service functions tested)
- All 771 tests pass, mypy clean

**US-60.5: Add sonarr service tests**
- Created `backend/tests/test_sonarr_service.py` with 54 tests covering all 8 functions:
  - `TestValidateSonarrConnection` (11 tests):
    - test_returns_true_on_200_success: Success path verification
    - test_uses_system_status_endpoint: Correct /api/v3/system/status endpoint called
    - test_sends_api_key_header: X-Api-Key header sent correctly
    - test_normalizes_trailing_slash: URL normalization (no double slashes)
    - test_returns_false_on_401_unauthorized: Invalid API key handling
    - test_returns_false_on_403_forbidden: Access denied handling
    - test_returns_false_on_404_not_found: Wrong URL handling
    - test_returns_false_on_500_server_error: Server error handling
    - test_returns_false_on_timeout: Timeout exception handling
    - test_returns_false_on_connection_error: Connection refused handling
    - test_returns_false_on_dns_error: DNS failure handling
  - `TestGetUserSonarrSettings` (3 tests): None when no settings, returns settings, user isolation
  - `TestSaveSonarrSettings` (5 tests): Create new, update existing, trailing slash, encryption, user isolation
  - `TestGetDecryptedSonarrApiKey` (5 tests): None key, decryption, empty string, special chars, unicode
  - `TestGetSonarrSeriesByTmdbId` (10 tests): Match, not found, empty, non-200, timeout, connection error, endpoint, trailing slash, missing tmdbId, None id
  - `TestGetSonarrTmdbToSlugMap` (9 tests): Mapping, empty, non-200, timeout, connection error, missing fields, empty slug, trailing slash
  - `TestDeleteSonarrSeries` (7 tests): Success, URL, delete_files params, non-200, timeout, connection error
  - `TestDeleteSeriesByTmdbId` (4 tests): Lookup and delete flows, not found, delete fails, delete_files param
- Coverage: sonarr.py 100% (all service functions tested)
- All 788 tests pass, mypy clean

**US-60.6: Add radarr service tests**
- Created `backend/tests/test_radarr_service.py` with 46 tests covering all 7 functions:
  - `TestValidateRadarrConnection` (11 tests):
    - test_returns_true_on_200_success: Success path verification
    - test_uses_system_status_endpoint: Correct /api/v3/system/status endpoint called
    - test_sends_api_key_header: X-Api-Key header sent correctly
    - test_normalizes_trailing_slash: URL normalization (no double slashes)
    - test_returns_false_on_401_unauthorized: Invalid API key handling
    - test_returns_false_on_403_forbidden: Access denied handling
    - test_returns_false_on_404_not_found: Wrong URL handling
    - test_returns_false_on_500_server_error: Server error handling
    - test_returns_false_on_timeout: Timeout exception handling
    - test_returns_false_on_connection_error: Connection refused handling
    - test_returns_false_on_dns_error: DNS failure handling
  - `TestGetUserRadarrSettings` (3 tests): None when no settings, returns settings, user isolation
  - `TestSaveRadarrSettings` (5 tests): Create new, update existing, trailing slash, encryption, user isolation
  - `TestGetDecryptedRadarrApiKey` (5 tests): None key, decryption, empty string, special chars, unicode
  - `TestGetRadarrMovieByTmdbId` (9 tests): Match, empty, non-200, timeout, connection error, endpoint, trailing slash, None id, multiple matches
  - `TestDeleteRadarrMovie` (8 tests): Success, URL, delete_files params, non-200, timeout, connection error, trailing slash
  - `TestDeleteMovieByTmdbId` (5 tests): Lookup and delete flows, not found, delete fails, delete_files param, default param
- Coverage: radarr.py 100% (all service functions tested)
- All 834 tests pass, mypy clean

**US-60.7: Add tasks module tests**
- Created `backend/tests/test_tasks.py` with 24 tests covering all task functions:
  - `TestGetConfiguredUserIds` (4 tests):
    - test_returns_empty_list_when_no_users_configured: Empty list when no settings
    - test_returns_user_ids_with_jellyfin_configured: Returns users with URL + API key
    - test_excludes_users_with_only_server_url: Excludes incomplete configs
    - test_excludes_users_with_only_api_key: Excludes incomplete configs
  - `TestSendSyncFailureNotificationForCeleryLogic` (6 tests):
    - test_notification_called_with_user_email: _get_user_email returns correct email
    - test_fallback_email_when_user_not_found: Uses user_X format when no email
    - test_get_user_email_returns_none_for_nonexistent_user: None for missing user
    - test_notification_wrapper_logs_warning_on_exception: Logs warning, doesn't raise
    - test_notification_wrapper_sends_with_correct_params: Correct service/error params
    - test_notification_wrapper_uses_fallback_email: Fallback email used when None
  - `TestSyncUserTaskLogic` (6 tests):
    - test_run_sync_for_user_calls_service: Calls run_user_sync correctly
    - test_sync_user_success_path: Returns sync result on success
    - test_sync_user_failure_returns_error_dict: Returns failed status on exception
    - test_sync_user_failure_sends_notification: Calls notification on failure
    - test_sync_user_failure_logs_error: Logs error with user ID
    - test_sync_user_logs_info_on_success: Logs start and completion
  - `TestGetUserEmail` (2 tests): Email lookup, None for missing user
  - `TestSyncAllUsersTask` (3 tests): Queues each user, handles empty list, logs info
  - `TestTestTask` (3 tests): Success with input, empty string, special chars
- All 856 tests pass, mypy clean

**US-61.1: Fix CLAUDE.md port documentation**
- Updated "Running the Project" section in `CLAUDE.md`:
  - Docker section now shows `localhost:8080` with note "(mapped from container port 8000)"
  - Backend Only section renamed to "Backend Only (without Docker)"
  - Direct uvicorn command now includes port 8000 in comment
- All port references now consistent:
  - Docker context: `localhost:8080` for backend
  - Direct uvicorn: `localhost:8000` for backend
  - Frontend: `localhost:5173` in both contexts
- No code changes, documentation only

**US-61.2: Update CLAUDE.md skills list**
- Listed all 21 skills in `CLAUDE.md` grouped by category:
  - **PRD Management (4)**: prd, ralph-init, prd-sync, prd-archive
  - **QA Skills (9)**: qa-accessibility, qa-api-contracts, qa-architecture, qa-documentation, qa-infra, qa-performance, qa-security, qa-test-coverage, qa-ux
  - **UX & Product (2)**: ux-expert, product-ideation
  - **Workflow & Utilities (6)**: morning-routine, review-suggestions, improve-claude-md, fix, skill-creator, setup-email
- Removed non-existent `/original-script` reference
- Updated project structure tree to show skill categories instead of individual files
- No code changes, documentation only

### 2026-01-28

**US-61.3: Fix README.md git clone URLs**
- Fixed inconsistent git clone URLs in `README.md`:
  - Quick Start: Changed `https://github.com/jimmmydore/media-janitor.git` to `https://github.com/JimmyDore/mediajanitor.git`
  - Installation: Changed `https://github.com/jimmy/media-janitor.git` to `https://github.com/JimmyDore/mediajanitor.git`
- Also updated `cd` commands from `cd media-janitor` to `cd mediajanitor` for consistency
- Verified correct GitHub username and repo name from git remote
- No code changes, documentation only

**US-62.1: Add Celery container health checks**
- Added health check to `celery-worker` in `docker-compose.yml`:
  - `celery -A app.celery_app inspect ping -d celery@$HOSTNAME`
  - Pings the specific worker to verify it's processing tasks
  - 30s interval, 10s timeout, 3 retries, 30s start_period
- Added health check to `celery-beat` in `docker-compose.yml`:
  - `pgrep -f 'celery.*beat'` to verify beat process is running
  - 30s interval, 10s timeout, 3 retries, 10s start_period
- Both services already have `restart: unless-stopped`, so unhealthy containers restart automatically
- Docker-compose syntax validated successfully

**US-62.2: Add container resource limits**
- Added `deploy.resources.limits.memory` to all 5 containers in `docker-compose.yml`:
  - backend: 512M (FastAPI + SQLAlchemy, handles API requests)
  - celery-worker: 512M (Background sync tasks, API calls to Jellyfin)
  - celery-beat: 128M (Lightweight scheduler, minimal memory needs)
  - frontend: 256M (Node.js serving static SvelteKit app)
  - redis: 256M (In-memory cache and Celery broker)
- Total maximum memory: ~1.7GB across all containers
- Documented limits in `CLAUDE.md` new "Infrastructure" section with table of limits and rationale
- Docker-compose YAML syntax validated successfully

**US-62.3: Configure log rotation**
- Added `logging` configuration to all 5 containers in `docker-compose.yml`:
  - driver: json-file
  - max-size: 10m (10MB per log file)
  - max-file: 3 (keep 3 rotated files)
- Each container limited to 30MB total log storage (3 files x 10MB)
- Total maximum log storage: ~150MB across all containers
- Prevents logs from filling disk indefinitely
- Docker-compose YAML syntax validated successfully

**US-62.4: Add deployment rollback mechanism** (also fixes US-62.5)
- Updated `.github/workflows/deploy.yml` with rollback capability:
  - Pre-build: Tags current `mediajanitor-backend:latest` and `mediajanitor-frontend:latest` as `:previous`
  - Build: Runs `docker-compose build --no-cache` to create new images
  - Deploy: Stops old containers, starts new ones
  - Health check: Polls `/health` endpoint (fixes US-62.5 - was using `/api/hello`)
  - On success: Cleans up `:previous` images to save disk space
  - On failure: Logs backend output, stops containers, restores `:previous` to `:latest`, restarts containers, verifies rollback
- Renamed step from "Health check" to "Health check with rollback"
- YAML syntax validated successfully

**US-62.6: Implement rolling deployment**
- Refactored `.github/workflows/deploy.yml` for zero-downtime deployments:
  - Replaced `docker-compose down` + `docker-compose up -d` with rolling updates
  - Services updated one at a time using `docker-compose up -d --no-deps --build <service>` pattern
  - Deployment order: redis -> backend -> celery-worker -> celery-beat -> frontend
  - Added `wait_for_healthy()` shell function to poll container health status
  - Each service waits for health check before proceeding to next
  - Backend additionally verified via curl to /health endpoint
  - Frontend (no health check) waits 10 seconds after start
- Updated final verification step:
  - Renamed from "Health check with rollback" to "Final health verification and cleanup"
  - Checks all container health statuses
  - Checks frontend is "Up" (no health check defined)
  - On failure: logs backend and celery-worker, attempts rollback
- Documented in CLAUDE.md new "Rolling Deployment (Zero-Downtime)" section:
  - Deployment order and rationale
  - How `--no-deps --build` pattern works
  - Benefits of rolling deployment
  - Rollback mechanism explanation
  - Manual rollback commands
- YAML syntax validated successfully

**US-62.7: Enhance health endpoint with dependency checks**
- Enhanced `/health` endpoint in `backend/app/main.py`:
  - Added `check_database_health()` function: executes `SELECT 1` to verify DB connectivity
  - Added `check_redis_health()` function: sends `PING` to verify Redis connectivity
  - Returns 200 with `{'status': 'healthy', 'dependencies': {'database': 'ok', 'redis': 'ok'}}` on success
  - Returns 503 with `{'status': 'unhealthy', 'dependencies': {...error details...}}` on failure
  - Redis shows `'not configured'` when `redis_url` is empty (graceful handling)
- Added 10 unit tests in `TestHealthEndpoint` class (`backend/tests/test_main.py`):
  - test_health_returns_200_when_all_dependencies_healthy
  - test_health_returns_database_status
  - test_health_returns_redis_status_when_configured
  - test_health_returns_503_when_database_fails
  - test_health_returns_503_when_redis_fails
  - test_health_returns_detailed_dependency_status
  - test_health_database_check_executes_query
  - test_health_redis_not_configured_returns_not_configured
  - test_health_database_failure_logged
- Updated existing CORS tests to mock Redis (no Redis in test environment)
- All 864 tests pass, mypy clean

### 2026-01-29

**US-63.1: Fetch Sonarr history during sync**
- `get_sonarr_history_since()` was already implemented in `backend/app/services/sonarr.py`:
  - Calls Sonarr API: `GET /api/v3/history/since?date={cutoff}&eventType=downloadFolderImported&includeSeries=true&includeEpisode=true`
  - Returns `dict[int, list[EpisodeHistoryEntry]]` mapping TMDB ID to episode additions
  - Gracefully returns empty dict on any error (timeout, connection error, non-200 response)
- Updated `backend/app/services/sync.py`:
  - Modified `cache_jellyseerr_requests()` to accept optional `sonarr_history` parameter
  - When provided, merges Sonarr history into `raw_data.sonarr_history` for TV show requests
  - Only TV shows (`media_type == "tv"`) with matching TMDB IDs get history attached
  - Movies and shows without history are unaffected
- Updated `run_user_sync()` in `sync.py`:
  - If user has Sonarr configured, fetches history using `get_sonarr_history_since()`
  - Uses `recently_available_days` setting (default 7) for days_back parameter
  - Gracefully handles Sonarr API failures with warning log, continues sync
  - Passes history to `cache_jellyseerr_requests()` for storage
- Added 4 tests in `TestSonarrHistoryIntegration` class (`backend/tests/test_sync.py`):
  - test_cache_jellyseerr_requests_with_sonarr_history
  - test_cache_jellyseerr_requests_without_sonarr_history
  - test_cache_jellyseerr_requests_empty_sonarr_history
  - test_sonarr_history_only_for_matching_tmdb_ids
- 11 existing tests in `TestGetSonarrHistorySince` class cover API functionality
- All 918 tests pass, mypy clean, 37 integration tests pass

**US-63.2: Smart episode grouping logic**
- Created `group_episodes_for_display()` function in `backend/app/services/content_queries.py`:
  - Takes list of episode additions (from Sonarr history) and total_episodes_per_season dict
  - Groups episodes by (date, season) for smart display
  - Applies grouping rules:
    - Full season (all episodes same day) → "Season X"
    - Consecutive episodes same day → "S2E5-E8" range format
    - Non-consecutive same day → "S2E3, S2E5, S2E7" comma-separated list
    - Single episode → "S2E5" format
  - Deduplicates episodes (handles multiple download events for same episode)
  - Returns sorted by date descending (most recent first)
- Created `EpisodeAddition` TypedDict with fields:
  - `added_date`: ISO date string (YYYY-MM-DD)
  - `display_text`: Smart formatted string
  - `season`: Season number
  - `episode_numbers`: List of episode numbers
  - `is_full_season`: Boolean indicating full season download
- Added `_is_consecutive()` helper function for consecutive number detection
- Exported via `content.py` facade for backwards compatibility
- Created `backend/tests/test_episode_grouping.py` with 14 comprehensive tests:
  - test_single_episode_returns_episode_format
  - test_full_season_returns_season_format
  - test_consecutive_episodes_same_day_returns_range_format
  - test_non_consecutive_episodes_same_day_returns_list_format
  - test_episodes_different_days_creates_multiple_groups
  - test_multiple_seasons_same_day_creates_separate_groups
  - test_empty_episodes_returns_empty_list
  - test_full_season_detection_with_missing_total_episodes
  - test_two_consecutive_episodes_uses_range_format
  - test_mixed_consecutive_and_non_consecutive_same_day
  - test_duplicate_episodes_are_deduplicated
  - test_returns_groups_sorted_by_date_descending
  - test_handles_specials_season_0
  - test_complex_scenario_multiple_seasons_multiple_days
- All 909 tests pass (895 unit + 14 new), mypy clean

**US-63.3: Update Recently Available API response**
- Added `EpisodeAdditionModel` Pydantic model to `backend/app/models/content.py`:
  - Fields: added_date (str), display_text (str), season (int), episode_numbers (list[int]), is_full_season (bool)
- Added `episode_additions: list[EpisodeAdditionModel] | None` field to `RecentlyAvailableItem`
- Created `_get_episode_additions_from_sonarr_history()` helper in `backend/app/services/content_queries.py`:
  - Returns None for movies (no episode concept)
  - Returns None for status 5 TV shows (use season_info instead per AC)
  - For status 4 TV shows with sonarr_history in raw_data:
    - Builds total_episodes_per_season from seasons data
    - Calls group_episodes_for_display() for smart grouping
    - Converts TypedDict results to Pydantic models
- Updated `get_recently_available()` to call the helper and populate episode_additions
- Added 7 tests in `TestRecentlyAvailableEpisodeAdditions` class:
  - test_episode_additions_field_present_in_response
  - test_episode_additions_from_sonarr_history_status_4
  - test_episode_additions_groups_consecutive_episodes
  - test_episode_additions_full_season_display
  - test_episode_additions_status_5_fully_available_no_additions
  - test_episode_additions_movie_always_none
  - test_episode_additions_fallback_when_no_sonarr_history
- All 937 tests pass, mypy clean, 37 integration tests pass

**US-63.4: Display episode-level info in frontend**
- Added `EpisodeAddition` TypeScript interface to `frontend/src/routes/info/recent/+page.svelte`:
  - Fields: added_date (string), display_text (string), season (number), episode_numbers (number[]), is_full_season (boolean)
- Added `episode_additions: EpisodeAddition[] | null` field to `RecentlyAvailableItem` interface
- Updated `getDetails()` function to prefer `episode_additions` when available:
  - Displays up to 3 addition display_texts comma-separated
  - Shows ellipsis ("...") when more than 3 additions
  - Falls back to existing season_info logic when episode_additions is null or empty
- Updated `frontend/tests/recent-episode-details.test.ts`:
  - Added EpisodeAddition interface
  - Updated all existing tests to include episode_additions: null field
  - Added 8 new tests in `getDetails() with episode_additions (US-63.4)` describe block:
    - test_prefers_single_episode_addition_display_text_over_season_info
    - test_shows_consecutive_episode_range_display_text
    - test_shows_full_season_display_text
    - test_shows_comma_separated_display_text_for_multiple_additions
    - test_shows_ellipsis_when_more_than_3_additions
    - test_falls_back_to_season_info_when_episode_additions_is_empty_array
    - test_shows_mixed_season_additions_correctly
  - Added copy feature test for episode_additions display
- All 797 frontend tests pass (24 in recent-episode-details.test.ts), typecheck passes
- Verified in browser: fallback to season_info works for status 5 TV shows and movies

**US-53.1: Add /dashboard route alias**
- Created `frontend/src/routes/dashboard/+page.ts` with redirect to `/`
  - Uses SvelteKit's `throw redirect(307, '/')` pattern
  - Works for both server-side and client-side navigation
- Navigating to `/dashboard` now shows dashboard content (same as `/`)
- Typecheck passes (0 errors, 4 pre-existing warnings)
- All 797 frontend unit tests pass
- E2E tests: 17 passed, 6 failed (pre-existing failures due to signup disabled)
- Verified in browser: `/dashboard` redirects to `/` and shows dashboard

**US-53.2: Redirect authenticated users from login/register pages**
- Updated `frontend/src/routes/login/+page.svelte`:
  - Replaced onMount + subscribe pattern with Svelte 5 `$effect()`
  - Redirects to dashboard (or redirect query param) when authenticated
  - Removed unused `mounted` state variable
- Updated `frontend/src/routes/register/+page.svelte`:
  - Added `$effect()` to redirect authenticated users to `/`
  - Removed unused `mounted` state variable
- Created `frontend/tests/auth-redirect.test.ts` with 9 unit tests:
  - Tests shouldRedirectAuthenticatedUser() logic function
  - Tests login and register page redirect scenarios
  - Tests loading state handling (no redirect while loading)
- All 806 frontend tests pass, typecheck passes
- Verified in browser:
  - Authenticated user visiting /login → redirected to /
  - Authenticated user visiting /register → redirected to /
  - Unauthenticated user can access both pages normally

**US-55.1: Standardize settings auto-save behavior**
- Added `debounce()` utility function to `frontend/src/lib/stores/index.ts`:
  - Delays function execution by specified wait time
  - Cancels previous call when called again within wait time
  - Generic TypeScript implementation with proper types
- Updated `frontend/src/routes/settings/display/+page.svelte`:
  - Added debounce import from stores
  - Created `debouncedSaveDays()` function with 300ms delay
  - Changed `recentlyAvailableDays` input from `onchange` to `oninput`
  - Now triggers save on every keystroke (debounced), not on blur
- Created `frontend/tests/settings-autosave.test.ts` with 18 tests:
  - Debounce utility tests (6 tests): delay, cancel, arguments, multiple calls, 0ms
  - Thresholds auto-save tests (6 tests): individual field saves, error handling
  - Display settings auto-save tests (6 tests): theme, days, toggle, language saves
- Consistent behavior across settings pages:
  - Display page: Theme (instant), Days (debounced), Toggle (instant), Language (instant)
  - Thresholds page: All number inputs use debounced auto-save
  - Connections page: Explicit Save button (requires validation before saving)
- All 824 frontend tests pass, typecheck passes

**US-56.1: Improve placeholder text contrast**
- Added `--text-placeholder` CSS variable to `frontend/src/app.css`:
  - Light mode: `var(--gray-500)` (#64748b) with 4.6:1 contrast ratio on white background
  - Dark mode: `var(--gray-400)` (#94a3b8) with 5.7:1 contrast ratio on gray-900 background
- Updated `.input::placeholder` to use `var(--text-placeholder)` instead of `var(--text-muted)`
- Both light and dark modes meet WCAG AA requirement (4.5:1 minimum)
- No code changes, CSS-only accessibility improvement
- All 824 frontend tests pass, typecheck passes (0 errors, 4 pre-existing warnings)

**US-56.2: Use semantic HTML on landing page**
- Updated `frontend/src/lib/components/Landing.svelte`:
  - Changed outer wrapper from `<div class="landing">` to `<main class="landing">` element
  - Changed 4 feature cards from `<div class="feature-card">` to `<article class="feature-card">`
- Verified existing semantic elements are in place:
  - `<header>` with `<nav>` for public header navigation
  - `<section>` for hero, features, preview, and trust sections
  - Heading hierarchy: h1 (hero title), h2 (section titles), h3 (feature card titles)
- Screen readers can now navigate by landmarks (main, header, nav, sections, articles)
- All 824 frontend tests pass, typecheck passes (0 errors, 4 pre-existing warnings)

**US-58.1: Extract Issues page components**
- Created `frontend/src/lib/components/DurationPickerModal.svelte`:
  - Reusable duration picker for whitelist operations
  - Supports permanent, 1 week, 1/3/6 months, and custom date options
  - Handles keyboard navigation, focus trapping, and auto-focus
- Created `frontend/src/lib/components/DeleteConfirmModal.svelte`:
  - Delete confirmation with Radarr/Sonarr and Jellyseerr checkboxes
  - Dynamically shows Arr name based on media type (Radarr for movies, Sonarr for series)
  - Warning banner with destructive action styling
- Created `frontend/src/lib/components/IssueRow.svelte`:
  - Single expandable table row with badges and actions
  - Handles all issue types (old, large, language, request)
  - Episode expansion with whitelist buttons for language issues
  - Service badges (Jellyfin, Jellyseerr, Radarr, Sonarr, TMDB)
- Created `frontend/src/lib/components/IssueFilters.svelte`:
  - Header with title, stats (count/size), search input
  - Filter tabs (All, Old, Large, Language, Unavailable)
  - Sub-filters for Large tab (All, Movies, Series)
- Refactored `frontend/src/routes/issues/+page.svelte`:
  - Reduced from ~2800 to ~1300 lines (~54% reduction)
  - Uses extracted components via imports
  - State management and API calls remain in page component
  - Components communicate via props and event handlers
- All 824 frontend tests pass, typecheck passes (0 errors)
- Verified in browser: filter tabs, search, row expansion, badges all working

**US-59.3: Add server-side pagination to library endpoint**
- Refactored `backend/app/services/content_queries.py` `get_library()` function:
  - Push filtering to SQL WHERE clauses (media_type, search with ILIKE, watched, year range, size range)
  - Added LIMIT/OFFSET pagination with default 50 items per page (configurable 1-100)
  - Use asyncio.gather for parallel count query (total_count + total_size for ALL matching items)
  - Sort column typing fixed with `Any` annotation for mypy
- Updated `backend/app/models/content.py`:
  - Added page, page_size, total_pages fields to LibraryResponse
- Updated `backend/app/routers/library.py`:
  - Added page (ge=1) and page_size (ge=1, le=100) query parameters
- Created `backend/tests/test_library.py::TestLibraryPagination` class with 12 tests:
  - Default pagination (50 items), custom page_size, page navigation
  - Pagination with filters, search, total_size calculation
  - Boundary conditions (max/min limits, beyond last page)
- Updated `frontend/src/routes/library/+page.svelte`:
  - Added pagination state (currentPage, pageSize)
  - Reset pagination to page 1 when filters change
  - Added pagination controls: prev/next buttons, page numbers with ellipsis, "Page X of Y" info
  - Styled pagination with responsive design for mobile
- Created `frontend/tests/library-pagination.test.ts` with 23 tests:
  - getPageNumbers() logic, LibraryResponse fields, URL params, state reset, navigation
- All 912 backend tests pass, 847 frontend tests pass, mypy clean
- Verified in Docker: API returns correct pagination fields
- Verified in browser: pagination UI works, page navigation works

---

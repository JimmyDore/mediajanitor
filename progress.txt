# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: Epic 35 - Issues Page Sorting Improvements (In Progress)
**Total Stories**: 47 stories (12 passes: true, 35 remaining)

---

## 2026-01-18: US-40.1 - Fix GitHub Repository Link

### Summary
Updated the Help page to link to the correct project repository (jimmydore/mediajanitor) instead of the placeholder link.

### Files Changed
- `frontend/src/routes/help/+page.svelte` - Updated contact section links

### Key Implementation Details
- Changed from single "GitHub Issues" link to anthropics/claude-code
- Now has two links: "view the project on GitHub" and "report an issue"
- Both point to `https://github.com/jimmydore/mediajanitor` and `https://github.com/jimmydore/mediajanitor/issues`
- Links have `target="_blank"` and `rel="noopener noreferrer"` for security

### Verification
- 530 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings - pre-existing)
- Verified in browser: links display correctly and have correct href attributes

---

## 2026-01-18: US-39.2 - Add Type Icons to Toasts

### Summary
Added type-specific icons to toast notifications for visual clarity. Success toasts show a checkmark, error toasts show an X, info toasts show an i-circle, and warning toasts show a triangle.

### Files Changed
- `frontend/src/lib/components/Toast.svelte` - Added inline SVG icons for each toast type, added warning toast type
- `frontend/tests/toast.test.ts` - Added 9 new tests for icon functionality

### Key Implementation Details
- Icons are inline SVGs (18x18px) positioned left of message text
- Success: checkmark (M3.5 9.5l4 4 7-8)
- Error: X shape (M4 4l10 10M14 4L4 14)
- Info: i inside circle
- Warning: exclamation inside triangle
- Icons use `stroke="currentColor"` to inherit white text color from toast
- Icon container has `aria-hidden="true"` (decorative, message text conveys meaning)
- Added new `warning` toast type with `--warning` amber background

### Verification
- 530 frontend unit tests pass (9 new tests)
- svelte-check passes (0 errors, 3 warnings - all pre-existing)
- Verified in browser: success toast shows checkmark icon, positioned left of message

### Learnings
- Inline SVGs are more maintainable than external icon libraries for small icon sets
- Using `currentColor` for stroke allows icons to inherit text color from parent

---

## 2026-01-18: US-38.3 - Recently Available Uses Language Preference

### Summary
Implemented language preference support for the Recently Available page. Users can now choose to view and copy content titles in French instead of English.

### Files Changed
- `backend/app/models/content.py` - Added `title_fr` field to `RecentlyAvailableItem` model
- `backend/app/services/content.py` - Return `title_fr` from database in API response
- `frontend/src/routes/info/recent/+page.svelte` - Read `title_language` preference, display titles based on preference, update copy function
- `frontend/tests/info.test.ts` - Added 6 new tests for title_fr field and language preference logic

### Key Implementation Details
- `RecentlyAvailableItem` now includes `title_fr: str | None` field
- Frontend reads `title_language` from `/api/settings/display` on page load
- `getDisplayTitle()` helper returns French title if `titleLanguage === 'fr'` and `title_fr` is available
- Falls back to English title when French title is null/unavailable
- Copy button also uses `getDisplayTitle()` to output titles in preferred language

### Verification
- 556 backend tests pass
- 493 frontend tests pass (6 new tests)
- mypy typecheck passes
- svelte-check passes (0 errors)
- 34 integration tests pass
- Verified in browser: titles switch between English and French based on setting

### Learnings
- The `title_fr` field was already populated during sync (US-38.2), so only API and frontend changes needed
- French title fallback to English happens in the frontend, not the backend

---

## 2026-01-18: US-37.2 - Display Prefilled Users in UI

### Summary
Verified that the display prefilled users feature was already fully implemented in US-36.4 and US-37.1. No code changes needed - just marked the story as complete.

### Existing Implementation
- `frontend/src/routes/settings/users/+page.svelte` - Users page displays prefilled Jellyfin users
- Warning badge (!) next to usernames with `has_jellyseerr_account=false`
- Tooltip explains: "This Jellyfin user was not found in Jellyseerr. They may not be able to request content."
- Empty display names show em-dash (—)
- Edit/delete functionality preserved

### Verification
- 487 frontend unit tests pass (16 for settings-users.test.ts)
- svelte-check passes (0 errors, 3 warnings)
- Verified in browser via Puppeteer: users table shows prefilled Jellyfin users with warning badges

### Key Implementation Details (Pre-existing)
- `has_jellyseerr_account` field added in US-37.1 backend sync
- Warning badge rendered with `{#if nickname.has_jellyseerr_account === false}`
- Empty state only shows when `nicknames.length === 0 && !showAddNicknameForm`

### Learnings
- Before implementing, always check if the feature is already complete by reviewing existing code
- The warning badge styling uses `--warning-light` background with `--warning` text color

---

## 2026-01-16: US-35.1 - Fix Watched Column Sort Order

### Summary
Fixed the Watched column sorting to properly handle three different states: items with dates, items marked as "Watched" (no date), and items marked as "Never" (never watched).

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added 'watched' to SortField type, implemented three-tier sorting logic, updated column header
- `frontend/tests/issues-sorting.test.ts` - New test file for watched column sorting logic

### Key Implementation Details
- Added `watched` to the `SortField` type union
- Implemented three-tier priority system: 1 = has date, 2 = played without date, 3 = never watched
- Descending order (first click): dates DESC → "Watched" → "Never"
- Ascending order (second click): "Never" → "Watched" → dates ASC
- Column header now uses 'watched' field for non-requests tabs (uses 'date' for Requested column)
- Sorting works for both movies and series

### Verification
- 423 frontend unit tests pass (12 new sorting tests)
- svelte-check passes (0 errors)
- Verified in browser using Puppeteer: clicking Watched column sorts correctly in both directions

---

## 2026-01-16: US-34.3 - Add Sorting to Requester and Release Columns

### Summary
Added sorting functionality to Requester and Release columns on the Unavailable tab of the Issues page.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added 'requester' and 'release' to SortField type, sorting logic, and clickable column headers

### Key Implementation Details
- Added `requester` and `release` to the `SortField` type union
- Implemented `requester` sorting: alphabetical comparison with nulls sorted last
- Implemented `release` sorting: date comparison with nulls sorted last
- Wrapped Requester and Release column headers with sort buttons
- Sort indicators (↑/↓) appear on active sort column
- Both columns default to descending order when first clicked

### Verification
- 411 frontend unit tests pass
- svelte-check passes (0 errors)
- Verified in browser using Puppeteer: both columns sort correctly in asc/desc order

---

## 2026-01-16: US-34.2 - Normalize Table Header Casing

### Summary
Changed table headers from ALL CAPS to Title Case for a more professional appearance.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Removed text-transform: uppercase from table header CSS

### Key Implementation Details
- Removed `text-transform: uppercase` and `letter-spacing: 0.05em` from `.issues-table th` CSS rule
- Headers now display as written in HTML: Name, Requester, Issues, Size, Added, Release, Requested/Watched
- Badge text (OLD, LANGUAGE, etc.) still uses uppercase via separate `.badge` CSS rule

### Verification
- 411 frontend unit tests pass
- svelte-check passes (0 errors)
- Verified in Docker: all headers display in Title Case

---

## 2026-01-16: US-34.1 - Hide Issues Column on Unavailable Tab

### Summary
Hid the Issues column on the Unavailable tab to give more space to the content name column.

### Files Changed
- `frontend/src/routes/issues/+page.svelte` - Added conditional rendering for Issues column and CSS for expanded Name column

### Key Implementation Details
- Added `{#if activeFilter !== 'requests'}` around Issues column header and cells
- Added `class:requests-view={activeFilter === 'requests'}` to table element
- Added CSS rule `.requests-view .col-name { width: 45%; }` to expand Name column
- Other tabs (All, Old, Large, Language) still show the Issues column at 35% width

### Verification
- 411 frontend unit tests pass
- svelte-check passes (0 errors)
- Verified in browser: Unavailable tab has no Issues column, Name column is wider
- Verified in browser: All/Old tabs still show Issues column

---

## 2026-01-16: US-44.4 - Reset Password Endpoint

### Summary
Created POST /api/auth/reset-password endpoint that allows users to submit a new password using a valid reset token.

### Files Changed
- `backend/app/models/user.py` - Added `ResetPasswordRequest`, `ResetPasswordResponse` models and `validate_password_strength()` function
- `backend/app/routers/auth.py` - Added `reset_password` endpoint
- `backend/tests/test_password_reset.py` - Added 11 new unit tests (TestResetPasswordEndpoint class)
- `backend/tests/test_integration.py` - Added 3 integration tests for reset-password validation

### Key Implementation Details
- Password validation with Pydantic `field_validator`: 8+ chars, uppercase, lowercase, number
- Iterates through all non-expired, unused tokens and compares bcrypt hashes
- Updates user's `hashed_password` with new bcrypt hash
- Marks token as `used=True` to prevent reuse
- Returns 200 OK with success message on valid reset
- Returns 400 Bad Request for invalid/expired/used tokens
- Returns 422 Unprocessable Entity for weak passwords (validation)

### Verification
- 547 backend tests pass (11 new tests)
- mypy typecheck passes
- 9 auth integration tests pass in Docker

### Learnings
- Pydantic `field_validator` decorator runs during request parsing, catching validation errors before endpoint code
- bcrypt.checkpw is used to safely compare incoming token with stored hashes

---

## 2026-01-16: US-44.3 - Request Password Reset Endpoint

### Summary
Created POST /api/auth/request-password-reset endpoint that allows users to request a password reset email.

### Files Changed
- `backend/app/models/user.py` - Added `PasswordResetRequest` and `PasswordResetResponse` Pydantic models
- `backend/app/routers/auth.py` - Added `request_password_reset` endpoint and `_check_password_reset_rate_limit` helper
- `backend/app/services/rate_limit.py` - Added `password_reset_rate_limiter` (3 requests/email/hour)
- `backend/tests/test_password_reset.py` - Added 10 new unit tests for endpoint and rate limiting
- `backend/tests/test_integration.py` - Added 3 integration tests for password reset endpoint

### Key Implementation Details
- Generates secure random token: `secrets.token_urlsafe(32)` (32 bytes, URL-safe base64)
- Hashes token with bcrypt before storage for security
- Token expires in 15 minutes from creation
- Deletes existing unused tokens for user before creating new one (only one active reset per user)
- Sends email via `send_password_reset_email()` service with reset URL
- Returns 200 OK even for non-existent emails (prevents email enumeration attacks)
- Rate limited to 3 requests per email per hour (in-memory RateLimiter keyed by email)

### Verification
- 533 backend tests pass (10 new tests + 3 integration tests)
- mypy typecheck passes
- 31 integration tests pass in Docker

### Learnings
- Rate limiting by email address (not IP) provides better protection for this endpoint
- The RateLimiter class has `_is_testing()` check that bypasses limits when TESTING=1
- For rate limit tests, must set TESTING=0 with `patch.dict(os.environ)` pattern

---

## 2026-01-16: US-44.2 - Email Service with SMTP2GO

### Summary
Created email service to send password reset emails using SMTP with STARTTLS.

### Files Changed
- `backend/app/config.py` - Added SMTP config settings (smtp_host, smtp_port, smtp_username, smtp_password, smtp_from_email, frontend_url)
- `backend/app/services/email.py` - New email service with send_password_reset_email() function
- `backend/tests/test_email.py` - 18 unit tests with mocked smtplib.SMTP

### Key Implementation Details
- Uses smtplib with STARTTLS for secure connection
- Sends both HTML and plain text email formats (multipart/alternative)
- Email includes: reset link (clickable), expiration time (15 minutes), user's email for reference
- Raises HTTPException 500 on SMTP errors (authentication, connection, general SMTP errors)
- Skips login if username/password are empty (for testing with local SMTP servers)
- Logs success message on email sent

### Verification
- 523 backend tests pass (18 new email tests)
- mypy typecheck passes

### Learnings
- smtplib context manager (`with`) automatically handles quit/disconnect
- MIMEMultipart("alternative") lets email clients choose HTML or plain text

---

## 2026-01-16: US-44.1 - Password Reset Token Model

### Summary
Created `PasswordResetToken` database model to store password reset tokens securely for the forgot password feature.

### Files Changed
- `backend/app/database.py` - Added `PasswordResetToken` model with all required fields
- `backend/alembic/versions/20260116_203015_*.py` - Migration to create table
- `backend/tests/test_password_reset.py` - Unit tests for model CRUD and constraints

### Key Implementation Details
- Fields: `id`, `user_id`, `token_hash`, `expires_at`, `created_at`, `used`
- `token_hash` column is indexed for fast lookup
- Foreign key to `users` table with `ON DELETE CASCADE` - tokens deleted when user is deleted
- `used` boolean flag to prevent token reuse

### Verification
- 505 backend tests pass (6 new tests for PasswordResetToken model)
- mypy typecheck passes
- 28 integration tests pass in Docker
- Table verified in Docker database with correct columns and foreign key

### Learnings
- CASCADE delete in SQLAlchemy requires `ondelete="CASCADE"` in ForeignKey definition
- SQLite in-memory tests may not enforce foreign keys (engine-specific behavior)

---

## 2026-01-16: US-33.1 - Calculate and Store Total Series Size

### Summary
Modified `calculate_season_sizes()` to also calculate and store the total series size (sum of all seasons) in `CachedMediaItem.size_bytes`. This enables the Library page to display actual series sizes instead of "Unknown size".

### Files Changed
- `backend/app/services/sync.py` - Added `total_series_size` accumulator, store in `size_bytes`
- `backend/tests/test_sync.py` - Added tests for total series size calculation

### Key Implementation Details
- `calculate_season_sizes()` now tracks both `largest_season_size` and `total_series_size`
- For each season, the season size is added to `total_series_size`
- After processing all seasons, `size_bytes` is updated with the total
- Log message now includes both total size and largest season size for debugging
- Frontend already uses `size_formatted` from API, so no frontend changes needed

### Verification
- 491 backend tests pass (added 1 new test for total series size)
- All 405 frontend tests pass
- mypy typecheck passes
- svelte-check passes
- 27 integration tests pass in Docker

### Learnings
- The `format_size()` function returns "Unknown size" when `size_bytes` is None or 0
- Once `size_bytes` is populated during sync, the Library page will automatically display proper sizes

---

## 2026-01-16: US-17.2.1 - Populate Sync Progress User Names

### Summary
Verified that sync progress user names feature was already fully implemented. No code changes needed - just marked the story as complete.

### Existing Implementation
- `backend/app/services/sync.py:456-460` - Extracts first user name in batch and passes to `update_sync_progress()`
- `frontend/src/routes/+page.svelte:159-160` - Displays "Fetching user X/Y: Name..." format

### Verification
- All 491 backend tests pass including `TestSyncProgressTracking` tests
- All 405 frontend tests pass including sync.test.ts and setup-checklist.test.ts
- Typecheck passes (mypy, svelte-check)
- Integration tests pass in Docker
- Visual verification attempted via Puppeteer (sync completes too fast to capture mid-progress)

### Key Implementation Details (Pre-existing)
- `fetch_jellyfin_media_with_progress()` processes users in batches of 3
- For each batch, it extracts the first user's display name: `first_user_name = batch_users[0].get("Name", "Unknown")`
- Passes this name to `update_sync_progress()` which stores it in `SyncStatus.current_user_name`
- API endpoint `/api/sync/status` returns the name in `progress.current_user_name`
- Frontend `formatProgressMessage()` formats: `Fetching user ${progress.current_step_progress}/${progress.current_step_total}: ${userName}...`

### Learnings
- Before implementing, always check if the feature is already complete by reviewing existing code
- The sync progress user names feature was implemented alongside the main sync progress tracking

---

## 2026-01-16: US-38.2 - Store French Titles During Sync

### Summary
Added ability to fetch and store French titles during sync, enabling future display of content in French.

### Files Changed
- `backend/app/database.py` - Added `title_fr` column to `CachedJellyseerrRequest` model
- `backend/app/services/sync.py` - Added `language` parameter to `fetch_media_details()`, added `extract_french_title_from_request()` helper, updated sync to fetch both English and French titles
- `backend/tests/test_sync.py` - Added tests for French title extraction and fetch_media_details with language
- `backend/alembic/versions/20260116_192531_*.py` - Migration for `title_fr` column

### Key Implementation Details
- `fetch_media_details()` now accepts `language` parameter (default: "en")
- During sync, the service makes two API calls per media item: one for English, one for French
- French titles are stored in `title_fr` (movies use `title_fr`, TV shows use `name_fr` from media details)
- `extract_french_title_from_request()` extracts French title from media object
- Missing French titles are stored as None (graceful degradation)
- Uses separate caches for EN and FR to avoid duplicate lookups

### Learnings
- The Jellyseerr API accepts a `language` parameter to fetch localized titles from TMDB
- Caching both languages separately prevents redundant API calls for the same TMDB ID

---

## 2026-01-16: US-38.1 - Add Title Language User Setting

### Summary
Added user setting to choose preferred language (English or French) for content titles. This is the first step toward supporting French title display.

### Files Changed
- `backend/app/database.py` - Added `title_language` column to `UserSettings` (String(2), default='en')
- `backend/app/models/settings.py` - Added `TitleLanguage` Literal type and fields to display preferences models
- `backend/app/routers/settings.py` - Updated GET/POST display endpoints to include `title_language`
- `backend/tests/test_integration.py` - Added integration tests for title_language API
- `backend/alembic/versions/20260116_191223_*.py` - Migration for `title_language` column
- `frontend/src/routes/settings/+page.svelte` - Added "Title language" dropdown to Display section

### Key Implementation Details
- TitleLanguage is a Literal type: `"en" | "fr"`
- Default value is "en" (English)
- Migration includes `server_default='en'` for existing rows
- Frontend dropdown saves on change (no save button needed)
- Includes proper loading states and error handling

### Learnings
- When adding a new NOT NULL column, always include `server_default` in migration for existing rows

---

## 2026-01-16: US-37.1 - Prefill Nicknames During Sync (Backend)

### Summary
Implemented automatic prefill of nickname records for all Jellyfin users during sync, including detection of users with Jellyseerr accounts.

### Files Changed
- `backend/app/database.py` - Added `has_jellyseerr_account` boolean field to `UserNickname` model
- `backend/app/models/settings.py` - Added `has_jellyseerr_account` to `NicknameItem` response model
- `backend/app/services/sync.py` - Added `fetch_jellyseerr_users()` and `prefill_user_nicknames()` functions
- `backend/app/services/nicknames.py` - Updated to include `has_jellyseerr_account` in list response
- `backend/app/routers/settings.py` - Updated nickname endpoints to return `has_jellyseerr_account`
- `backend/tests/test_nickname_prefill.py` - New test file for nickname prefill functionality
- `backend/tests/test_sync.py` - Updated existing tests to mock new functions
- `backend/tests/test_sync_mocked_integration.py` - Added Jellyseerr users mock
- `backend/alembic/versions/20260116_184830_*.py` - Migration for `has_jellyseerr_account` column

### Key Implementation Details
- `fetch_jellyseerr_users()` calls `/api/v1/user` endpoint and returns empty list on error (graceful degradation)
- `prefill_user_nicknames()` creates nickname records for each Jellyfin user during sync
  - Preserves existing mappings (only creates if not exists)
  - Matches Jellyfin usernames against Jellyseerr users (case-insensitive)
  - Sets `has_jellyseerr_account=True` for users found in Jellyseerr
- Display name is left empty for user to fill in later

### Learnings
- When adding new API calls to sync service, remember to update all existing sync tests to mock the new functions
- `respx` mocks require explicit routes for every HTTP call made during test

---

## 2026-01-16: US-37.3 - Manual Refresh Button for Jellyfin Users

### Summary
Added a "Refresh users" button on the Settings page that allows users to manually fetch Jellyfin users and populate the nickname list without waiting for the next sync.

### Files Changed
- `backend/app/models/settings.py` - Added `NicknameRefreshResponse` model
- `backend/app/routers/settings.py` - Added `POST /api/settings/nicknames/refresh` endpoint
- `backend/tests/test_settings.py` - Added 6 tests for refresh endpoint
- `backend/tests/test_integration.py` - Added integration test for refresh endpoint
- `frontend/src/routes/settings/+page.svelte` - Added "Refresh users" button with loading state
- `frontend/tests/settings-nicknames.test.ts` - Added 6 tests for refresh API contract

### Key Implementation Details
- Endpoint reuses existing `fetch_jellyfin_users()`, `fetch_jellyseerr_users()`, and `prefill_user_nicknames()` from sync service
- Returns 400 if Jellyfin not configured, 500 if Jellyfin API fails
- Response includes `success`, `message` (human-readable), and `new_users_count`
- Button only visible when `hasJellyfinConfigured` is true
- Shows loading spinner and disables button during refresh

### Verification
- 498 backend tests pass (6 new tests)
- 411 frontend tests pass (6 new tests)
- 28 integration tests pass (1 new test)
- mypy typecheck passes
- svelte-check passes

### Learnings
- Can reuse sync service functions in settings router by importing from `app.services.sync`
- Import `Any` from typing when using `dict[str, Any]` type hints

---

## 2025-01-16: US-28.1 - Loading States Accessibility

### Summary
Added accessibility attributes to loading states across all main pages so screen readers can announce loading status and content updates.

### Files Changed
- `frontend/src/routes/+page.svelte` - Dashboard with aria-busy, aria-live on stats grid
- `frontend/src/routes/issues/+page.svelte` - Issues page with aria-busy, aria-live on table
- `frontend/src/routes/settings/+page.svelte` - Settings page with aria-busy, role="status" on loading
- `frontend/src/routes/library/+page.svelte` - Library page with aria-busy, aria-live on table
- `frontend/src/routes/whitelist/+page.svelte` - Whitelist page with aria-busy, aria-live on list
- `frontend/src/routes/info/recent/+page.svelte` - Recent page with aria-busy, aria-live on table

### Key Implementation Details
- `aria-busy="true/false"` on parent containers (dashboard, issues-page, settings-page, library-page, whitelist-page, page) - dynamically set based on loading state
- `role="status"` and `aria-label="Loading..."` on loading div elements
- `aria-hidden="true"` on spinner elements (decorative)
- `aria-live="polite"` on table/list containers that update with content
- `aria-live="assertive"` on toast notifications

### Verification
- 523 backend tests pass
- 411 frontend tests pass
- svelte-check passes (0 errors)
- Verified in browser using Puppeteer - all aria attributes present

### Learnings
- `aria-busy` should be on the container that changes during load (toggles between content and loading state)
- `aria-live="polite"` announces updates without interrupting the user
- `aria-live="assertive"` for urgent messages like error toasts
- Spinners should have `aria-hidden="true"` since the `role="status"` on parent provides context

---

## 2026-01-18: US-35.2 - Display Last Watched Date for Series

### Summary
Fixed series showing "Watched" instead of actual last watched date. Jellyfin tracks watch data at the episode level, not the series level. Modified the sync process to fetch episode UserData from all Jellyfin users and aggregate the most recent LastPlayedDate.

### Files Changed
- `backend/app/services/sync.py` - Added get_most_recent_episode_played_date(), modified fetch_season_episodes() and calculate_season_sizes()
- `backend/tests/test_sync.py` - Added 6 new tests for get_most_recent_episode_played_date(), updated existing tests with mock for fetch_jellyfin_users

### Key Implementation Details
- `fetch_season_episodes()` now accepts optional `jellyfin_user_id` parameter and includes `UserData` in API request
- `calculate_season_sizes()` fetches all Jellyfin users, then for each season fetches episode UserData for each user
- `get_most_recent_episode_played_date()` iterates through all episodes and returns the most recent LastPlayedDate
- Frontend `formatLastWatched()` already displays dates correctly when data is present

### Root Cause Analysis
- Jellyfin API returns `UserData.LastPlayedDate` at the episode level, not series level
- Series items have `played=True` but `LastPlayedDate=None` in the API response
- Previous sync only stored the series-level UserData which lacked the date

### Verification
- 97 sync tests pass (6 new tests for get_most_recent_episode_played_date)
- mypy typecheck passes (32 source files)
- Manual testing requires a full sync to populate episode watch data

### Learnings
- Jellyfin stores watch data per-episode, aggregated data must be computed
- When adding new dependencies in functions, update existing test mocks accordingly
- Consider API rate limiting when making additional calls during sync

---

## 2026-01-18: US-36.1 - Settings Layout with Sidebar Navigation

### Summary
Created a new settings layout with sidebar navigation, breadcrumb, and placeholder sub-pages. The settings page now redirects to /settings/connections by default, with navigation to Connections, Thresholds, Users, and Display sections.

### Files Changed
- `frontend/src/routes/settings/+layout.svelte` - New layout with sidebar navigation and breadcrumb
- `frontend/src/routes/settings/+page.server.ts` - Server-side redirect to /settings/connections
- `frontend/src/routes/settings/+page.svelte` - Deleted (content will be extracted to sub-pages)
- `frontend/src/routes/settings/connections/+page.svelte` - Placeholder page for connections
- `frontend/src/routes/settings/thresholds/+page.svelte` - Placeholder page for thresholds
- `frontend/src/routes/settings/users/+page.svelte` - Placeholder page for users
- `frontend/src/routes/settings/display/+page.svelte` - Placeholder page for display
- `frontend/e2e/settings.spec.ts` - Updated E2E tests for new layout
- `frontend/e2e/auth-flow.spec.ts` - Updated to expect /settings/connections redirect
- `frontend/e2e/header.spec.ts` - Updated to expect /settings/connections redirect

### Key Implementation Details
- Layout uses flexbox with sidebar on left, content on right
- Breadcrumb shows: Dashboard > Settings > [Section Name]
- Active nav item highlighted with accent background color
- Server-side redirect using `throw redirect(307, '/settings/connections')`
- Responsive: @media (max-width: 768px) changes sidebar to horizontal scrollable tabs
- Icons for each nav item (plug, sliders, users, monitor) using inline SVG

### Verification
- 423 frontend unit tests pass
- svelte-check passes (0 errors, 3 warnings)
- 23 E2E tests pass
- Verified in browser: sidebar navigation works, redirect works, mobile responsive

### Learnings
- SvelteKit redirects must use `throw redirect()` not just `redirect()`
- New route directories require Docker rebuild to be picked up (HMR doesn't detect new folders)
- E2E tests that create users can hit rate limits when run in parallel

---

## 2026-01-18: US-36.2 - Extract Connections Page

### Summary
Extracted the API connections section from the deleted settings page into a dedicated `/settings/connections/+page.svelte` page. This is the first of four extraction stories (US-36.2 through US-36.5) to complete the settings page refactoring.

### Files Changed
- `frontend/src/routes/settings/connections/+page.svelte` - Full implementation of connections page
- `frontend/tests/settings-connections.test.ts` - New test file with 15 API contract tests

### Key Implementation Details
- All four service connection forms: Jellyfin, Jellyseerr, Radarr, Sonarr
- Each service has expand/collapse functionality with Edit/Cancel button
- Status indicators: green dot for connected, gray dot for not connected
- Domain extraction shows hostname instead of full URL (e.g., "jellyfin.example.com")
- Form shows "(leave blank to keep)" hint for API key when editing existing connection
- Auto-expand forms for unconfigured services (Jellyfin, Jellyseerr only)
- Auto-sync after first Jellyfin configuration if user has never synced
- Loading state with spinner during initial fetch
- Inline success/error messages for each form
- Responsive design: form fields stack vertically on mobile

### Verification
- 438 frontend unit tests pass (15 new tests)
- svelte-check passes (0 errors, 3 warnings)
- Verified in Docker: all connection forms load, expand, and display correctly
- Verified: status dots show correct colors based on configuration state

### Learnings
- The old settings page was deleted in US-36.1, but git history preserves the original code
- Code extraction from git history: `git show COMMIT^:path/to/file`
- Each settings sub-page manages its own state independently (no shared state between pages)

---

## 2026-01-18: US-36.3 - Extract Thresholds Page

### Summary
Extracted the analysis thresholds section from the deleted settings page into a dedicated `/settings/thresholds/+page.svelte` page. This is the second of four extraction stories to complete the settings page refactoring.

### Files Changed
- `frontend/src/routes/settings/thresholds/+page.svelte` - Full implementation of thresholds page
- `frontend/tests/settings-thresholds.test.ts` - New test file with 15 API contract tests

### Key Implementation Details
- Four threshold inputs: Old content months, Min age months, Large movie size, Large season size
- Help text shows which feature uses each threshold (e.g., "Used by: Old tab")
- Save button submits all values via POST /api/settings/analysis
- Reset button calls DELETE /api/settings/analysis to restore defaults
- Loading state with spinner during initial fetch
- Inline success/error messages
- Responsive: threshold rows stack vertically on mobile (≤600px)
- Default values: 4 months, 3 months, 13 GB, 15 GB

### Verification
- 453 frontend unit tests pass (15 new tests)
- svelte-check passes (0 errors, 3 warnings)
- Verified in Docker: page loads, Save works, Reset works
- Verified: changed value from 4 to 6, then Reset restored to 4

### Learnings
- Thresholds section already had a dedicated API endpoint (GET/POST/DELETE /api/settings/analysis)
- Old settings page was deleted in US-36.1; code extracted from git history
- Svelte 5 uses $state() for reactive state instead of let

---

## 2026-01-18: US-36.4 - Extract Users Page

### Summary
Extracted the user nicknames section from the deleted settings page into a dedicated `/settings/users/+page.svelte` page. This is the third of four extraction stories to complete the settings page refactoring.

### Files Changed
- `frontend/src/routes/settings/users/+page.svelte` - Full implementation of users/nicknames page
- `frontend/tests/settings-users.test.ts` - New test file with 16 API contract tests

### Key Implementation Details
- Table displays existing mappings: Jellyseerr Username → Display Name
- Warning badge (!) for users with `has_jellyseerr_account=false` (Jellyfin users not found in Jellyseerr)
- Edit mode: inline input field with Save/Cancel buttons
- Delete confirmation: inline "Delete this nickname?" with Confirm/Cancel buttons
- Empty state with "Add nickname" call-to-action button
- "Refresh users" button (only when Jellyfin configured) fetches Jellyfin users to populate list
- Toast feedback on all CRUD operations
- Responsive: table scrolls horizontally on mobile, header stacks vertically

### Verification
- 469 frontend unit tests pass (16 new tests)
- svelte-check passes (0 errors, 3 warnings)
- Verified in Docker: table loads, edit mode works, delete confirmation works
- Verified: warning badges display for users without Jellyseerr accounts

### Learnings
- Old settings page was deleted in US-36.1; code extracted from git history using `git show`
- The `has_jellyseerr_account` field was added in US-37.1 to mark users found in both Jellyfin and Jellyseerr
- Empty display names show "—" (em dash) instead of blank for visual clarity

---

## 2026-01-18: US-36.5 - Extract Display Page

### Summary
Extracted the display preferences section from the deleted settings page into a dedicated `/settings/display/+page.svelte` page. This is the final extraction story in the settings page refactoring series (US-36.1 through US-36.5).

### Files Changed
- `frontend/src/routes/settings/display/+page.svelte` - Full implementation of display settings page
- `frontend/tests/settings-display-page.test.ts` - New test file with 18 API contract tests

### Key Implementation Details
- Theme selector (Light/Dark/System) - changes apply immediately via theme store
- Title language dropdown (English/French) - saves on change
- Recently available days input (1-30 range) - saves on change
- Show unreleased requests toggle - saves on change
- Each setting calls POST /api/settings/display with a partial update (single field)
- Loading state with spinner during initial fetch
- Saving indicator shows when any setting is being saved
- Responsive: setting rows stack vertically on mobile (≤600px)

### Verification
- 487 frontend unit tests pass (18 new tests)
- svelte-check passes (0 errors, 3 warnings - all pre-existing)
- Verified in Docker: all display settings load, change, and persist correctly
- Theme changes apply immediately to the UI

### Learnings
- The old settings page was deleted in US-36.1; this completes the extraction series
- Using partial updates (one field per POST) simplifies the save logic and provides instant feedback
- The theme store already had `setPreference()` method to apply theme changes to the DOM

---

## 2026-01-18: US-39.1 - Add Manual Dismiss Button to Toasts

### Summary
Added manual dismiss button to all toast notifications with keyboard accessibility and ARIA labels.

### Files Changed
- `frontend/src/lib/components/Toast.svelte` - New reusable Toast component with close button
- `frontend/tests/toast.test.ts` - 28 new unit tests for Toast component
- `frontend/src/routes/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/issues/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/whitelist/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/info/recent/+page.svelte` - Updated to use Toast component
- `frontend/src/routes/content/old-unwatched/+page.svelte` - Updated to use Toast component

### Key Implementation Details
- Toast.svelte component with X close button in top-right corner
- Keyboard accessible: Tab to focus, Enter/Space to activate close
- aria-label="Close notification" for screen reader accessibility
- SVG X icon with aria-hidden="true" (decorative)
- Close button has hover/focus styles for visual feedback
- Each page tracks toastTimer to clear on manual close
- Auto-dismiss after 3 seconds still works if not manually closed
- Supports success, error, and info toast types

### Verification
- 521 frontend unit tests pass (28 new tests)
- svelte-check passes (0 errors, 3 warnings - all pre-existing)
- Docker build succeeds
- Toast component renders correctly in browser

---

## Notes

- US-0.2 (Dockerize) was completed together with US-0.1 since Docker setup was needed for testing
- Backend runs on port 8080 (mapped from 8000), Frontend on port 5173
- API proxy configured in vite.config.ts for dev environment
- Production: https://mediajanitor.com with HTTPS via Let's Encrypt
- CI/CD: Push to main triggers auto-deploy to VPS

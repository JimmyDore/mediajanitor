# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: Epic 38 - Title Language Preference (In Progress)
**Total Stories**: 47 stories (4 passes: true, 43 remaining)

---

## 2026-01-16: US-17.2.1 - Populate Sync Progress User Names

### Summary
Verified that sync progress user names feature was already fully implemented. No code changes needed - just marked the story as complete.

### Existing Implementation
- `backend/app/services/sync.py:456-460` - Extracts first user name in batch and passes to `update_sync_progress()`
- `frontend/src/routes/+page.svelte:159-160` - Displays "Fetching user X/Y: Name..." format

### Verification
- All 491 backend tests pass including `TestSyncProgressTracking` tests
- All 405 frontend tests pass including sync.test.ts and setup-checklist.test.ts
- Typecheck passes (mypy, svelte-check)
- Integration tests pass in Docker
- Visual verification attempted via Puppeteer (sync completes too fast to capture mid-progress)

### Key Implementation Details (Pre-existing)
- `fetch_jellyfin_media_with_progress()` processes users in batches of 3
- For each batch, it extracts the first user's display name: `first_user_name = batch_users[0].get("Name", "Unknown")`
- Passes this name to `update_sync_progress()` which stores it in `SyncStatus.current_user_name`
- API endpoint `/api/sync/status` returns the name in `progress.current_user_name`
- Frontend `formatProgressMessage()` formats: `Fetching user ${progress.current_step_progress}/${progress.current_step_total}: ${userName}...`

### Learnings
- Before implementing, always check if the feature is already complete by reviewing existing code
- The sync progress user names feature was implemented alongside the main sync progress tracking

---

## 2026-01-16: US-38.2 - Store French Titles During Sync

### Summary
Added ability to fetch and store French titles during sync, enabling future display of content in French.

### Files Changed
- `backend/app/database.py` - Added `title_fr` column to `CachedJellyseerrRequest` model
- `backend/app/services/sync.py` - Added `language` parameter to `fetch_media_details()`, added `extract_french_title_from_request()` helper, updated sync to fetch both English and French titles
- `backend/tests/test_sync.py` - Added tests for French title extraction and fetch_media_details with language
- `backend/alembic/versions/20260116_192531_*.py` - Migration for `title_fr` column

### Key Implementation Details
- `fetch_media_details()` now accepts `language` parameter (default: "en")
- During sync, the service makes two API calls per media item: one for English, one for French
- French titles are stored in `title_fr` (movies use `title_fr`, TV shows use `name_fr` from media details)
- `extract_french_title_from_request()` extracts French title from media object
- Missing French titles are stored as None (graceful degradation)
- Uses separate caches for EN and FR to avoid duplicate lookups

### Learnings
- The Jellyseerr API accepts a `language` parameter to fetch localized titles from TMDB
- Caching both languages separately prevents redundant API calls for the same TMDB ID

---

## 2026-01-16: US-38.1 - Add Title Language User Setting

### Summary
Added user setting to choose preferred language (English or French) for content titles. This is the first step toward supporting French title display.

### Files Changed
- `backend/app/database.py` - Added `title_language` column to `UserSettings` (String(2), default='en')
- `backend/app/models/settings.py` - Added `TitleLanguage` Literal type and fields to display preferences models
- `backend/app/routers/settings.py` - Updated GET/POST display endpoints to include `title_language`
- `backend/tests/test_integration.py` - Added integration tests for title_language API
- `backend/alembic/versions/20260116_191223_*.py` - Migration for `title_language` column
- `frontend/src/routes/settings/+page.svelte` - Added "Title language" dropdown to Display section

### Key Implementation Details
- TitleLanguage is a Literal type: `"en" | "fr"`
- Default value is "en" (English)
- Migration includes `server_default='en'` for existing rows
- Frontend dropdown saves on change (no save button needed)
- Includes proper loading states and error handling

### Learnings
- When adding a new NOT NULL column, always include `server_default` in migration for existing rows

---

## 2026-01-16: US-37.1 - Prefill Nicknames During Sync (Backend)

### Summary
Implemented automatic prefill of nickname records for all Jellyfin users during sync, including detection of users with Jellyseerr accounts.

### Files Changed
- `backend/app/database.py` - Added `has_jellyseerr_account` boolean field to `UserNickname` model
- `backend/app/models/settings.py` - Added `has_jellyseerr_account` to `NicknameItem` response model
- `backend/app/services/sync.py` - Added `fetch_jellyseerr_users()` and `prefill_user_nicknames()` functions
- `backend/app/services/nicknames.py` - Updated to include `has_jellyseerr_account` in list response
- `backend/app/routers/settings.py` - Updated nickname endpoints to return `has_jellyseerr_account`
- `backend/tests/test_nickname_prefill.py` - New test file for nickname prefill functionality
- `backend/tests/test_sync.py` - Updated existing tests to mock new functions
- `backend/tests/test_sync_mocked_integration.py` - Added Jellyseerr users mock
- `backend/alembic/versions/20260116_184830_*.py` - Migration for `has_jellyseerr_account` column

### Key Implementation Details
- `fetch_jellyseerr_users()` calls `/api/v1/user` endpoint and returns empty list on error (graceful degradation)
- `prefill_user_nicknames()` creates nickname records for each Jellyfin user during sync
  - Preserves existing mappings (only creates if not exists)
  - Matches Jellyfin usernames against Jellyseerr users (case-insensitive)
  - Sets `has_jellyseerr_account=True` for users found in Jellyseerr
- Display name is left empty for user to fill in later

### Learnings
- When adding new API calls to sync service, remember to update all existing sync tests to mock the new functions
- `respx` mocks require explicit routes for every HTTP call made during test

---

## Notes

- US-0.2 (Dockerize) was completed together with US-0.1 since Docker setup was needed for testing
- Backend runs on port 8080 (mapped from 8000), Frontend on port 5173
- API proxy configured in vite.config.ts for dev environment
- Production: https://mediajanitor.com with HTTPS via Let's Encrypt
- CI/CD: Push to main triggers auto-deploy to VPS

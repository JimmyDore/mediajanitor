# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: All epics complete - ready for new features
**Total Stories**: 191 stories completed (see ARCHIVED_PRD.md)

---

## Completed Tasks

Task logs archived to ARCHIVED_PROGRESS.txt on 2026-01-19.

### 2026-01-22

**US-48.1: Ultra API Settings - Backend**
- Added `ultra_api_url` and `ultra_api_key_encrypted` columns to UserSettings model
- Created Alembic migration `30dd116f11f8_add_ultra_api_settings_to_user_settings`
- Created `app/services/ultra.py` with save/get functions (following Radarr/Sonarr pattern)
- Added Pydantic models: `UltraSettingsCreate`, `UltraSettingsResponse`
- Added POST/GET `/api/settings/ultra` endpoints
- Files changed: `database.py`, `models/settings.py`, `routers/settings.py`, `services/ultra.py`, migration file
- 8 unit tests added (all pass), verified in Docker

**US-48.3: Ultra Warning Thresholds - Settings**
- Added `ultra_storage_warning_gb` and `ultra_traffic_warning_percent` columns to UserSettings model
- Created Alembic migration `26a3b23ff8ca_add_ultra_warning_thresholds_to_user_settings`
- Added Pydantic models: `UltraThresholdsCreate`, `UltraThresholdsResponse`
- Added POST/GET `/api/settings/ultra/thresholds` endpoints with defaults (100 GB, 20%)
- Added Seedbox Monitoring section to Settings/Connections page with Ultra.cc connection and Warning Thresholds
- Files changed: `database.py`, `models/settings.py`, `routers/settings.py`, `connections/+page.svelte`, migration file
- 12 backend tests + 14 frontend tests added (all pass), verified in Docker and browser

---

# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: All epics complete - ready for new features
**Total Stories**: 209 stories completed (see ARCHIVED_PRD.md)

---

## Completed Tasks

Task logs archived to ARCHIVED_PROGRESS.txt on 2026-01-23.

### 2026-01-24

**US-57.1: Split content.py into focused modules**
- Created `backend/app/services/whitelist.py` (558 lines)
  - All whitelist CRUD operations for 6 whitelist types
- Created `backend/app/services/content_analysis.py` (423 lines)
  - Analysis functions: is_old_or_unwatched, is_large_movie, has_language_issues, etc.
  - Constants, types, and utility functions
- Created `backend/app/services/content_queries.py` (880 lines)
  - Query functions: get_content_summary, get_content_issues, get_library
  - Recently available, unavailable requests, season/episode helpers
- Updated `backend/app/services/content.py` (197 lines)
  - Now a thin facade that re-exports all functions for backwards compatibility
- All 694 tests pass, mypy clean, no API changes

**US-57.2: Extract generic whitelist service base class**
- Created `backend/app/services/whitelist_base.py` (~260 lines)
  - BaseJellyfinIdWhitelistService for ContentWhitelist, FrenchOnly, LanguageExempt, Large
  - BaseJellyseerrIdWhitelistService for JellyseerrRequest
  - Generic CRUD: add(), get_list(), remove(), get_ids()
- Refactored `backend/app/services/whitelist.py` (from 748 to ~330 lines)
  - Service classes delegate to base classes
  - EpisodeLanguageExempt kept as-is (different field structure)
- Fixed test imports for _get_recent_episodes_from_cached_data
- All 657 tests pass, mypy clean, no API changes

**US-57.3: Consolidate whitelist router endpoints**
- Refactored `backend/app/routers/whitelist.py` (from 516 to 435 lines, ~16% reduction)
  - Created `create_jellyfin_whitelist_routes()` endpoint factory function
  - Generates GET/POST/DELETE for 4 jellyfin-id-based whitelists (content, french-only, language-exempt, large)
  - Requests endpoint kept separate (has special TMDB title lookup logic)
  - Episode-exempt endpoint kept separate (different field structure)
- All 6 whitelist types maintain exact same API contracts (URLs, request/response models)
- OpenAPI schema documents all 18 endpoints properly
- All 694 tests pass, mypy clean, Docker verified

---

# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Current Status

**Phase**: All epics complete - ready for new features
**Total Stories**: 209 stories completed (see ARCHIVED_PRD.md)

---

## Completed Tasks

Task logs archived to ARCHIVED_PROGRESS.txt on 2026-01-23.

### 2026-01-24

**US-57.1: Split content.py into focused modules**
- Created `backend/app/services/whitelist.py` (558 lines)
  - All whitelist CRUD operations for 6 whitelist types
- Created `backend/app/services/content_analysis.py` (423 lines)
  - Analysis functions: is_old_or_unwatched, is_large_movie, has_language_issues, etc.
  - Constants, types, and utility functions
- Created `backend/app/services/content_queries.py` (880 lines)
  - Query functions: get_content_summary, get_content_issues, get_library
  - Recently available, unavailable requests, season/episode helpers
- Updated `backend/app/services/content.py` (197 lines)
  - Now a thin facade that re-exports all functions for backwards compatibility
- All 694 tests pass, mypy clean, no API changes

**US-57.2: Extract generic whitelist service base class**
- Created `backend/app/services/whitelist_base.py` (~260 lines)
  - BaseJellyfinIdWhitelistService for ContentWhitelist, FrenchOnly, LanguageExempt, Large
  - BaseJellyseerrIdWhitelistService for JellyseerrRequest
  - Generic CRUD: add(), get_list(), remove(), get_ids()
- Refactored `backend/app/services/whitelist.py` (from 748 to ~330 lines)
  - Service classes delegate to base classes
  - EpisodeLanguageExempt kept as-is (different field structure)
- Fixed test imports for _get_recent_episodes_from_cached_data
- All 657 tests pass, mypy clean, no API changes

**US-57.3: Consolidate whitelist router endpoints**
- Refactored `backend/app/routers/whitelist.py` (from 516 to 435 lines, ~16% reduction)
  - Created `create_jellyfin_whitelist_routes()` endpoint factory function
  - Generates GET/POST/DELETE for 4 jellyfin-id-based whitelists (content, french-only, language-exempt, large)
  - Requests endpoint kept separate (has special TMDB title lookup logic)
  - Episode-exempt endpoint kept separate (different field structure)
- All 6 whitelist types maintain exact same API contracts (URLs, request/response models)
- OpenAPI schema documents all 18 endpoints properly
- All 694 tests pass, mypy clean, Docker verified

**US-57.4: Move business logic from content router to services**
- Created `backend/app/services/content_cache.py` (~140 lines)
  - get_user_settings: Get user settings from database
  - lookup_jellyseerr_media_by_tmdb: Look up Jellyseerr media ID by TMDB ID
  - lookup_jellyseerr_media_by_request_id: Look up media ID by request ID
  - delete_cached_media_by_tmdb_id: Delete cached media by TMDB ID
  - delete_cached_jellyseerr_request_by_tmdb_id: Delete cached request by TMDB
  - delete_cached_jellyseerr_request_by_id: Delete cached request by ID
- Updated `backend/app/services/content.py` to re-export cache functions
- Refactored `backend/app/routers/content.py` (from 528 to 403 lines, ~24% reduction)
  - Router now only handles HTTP concerns
  - All business logic moved to services
- All 694 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-59.1: Parallelize content summary queries**
- Updated `backend/app/services/content_queries.py` `get_content_summary()` function
  - Used `asyncio.gather()` to parallelize 5 independent whitelist queries:
    - `get_large_whitelist_ids(db, user_id)`
    - `get_french_only_ids(db, user_id)`
    - `get_language_exempt_ids(db, user_id)`
    - `get_unavailable_requests_count(db, user_id)`
    - `get_recently_available_count(db, user_id)`
  - These queries were previously called sequentially, now run in parallel
- Added tests in `TestContentSummaryParallelization` class to verify whitelist handling
- All 696 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-59.2: Parallelize content issues queries**
- Updated `backend/app/services/content_queries.py` `get_content_issues()` function
  - Used `asyncio.gather()` to parallelize 5 independent queries:
    - `get_user_thresholds(db, user_id)`
    - `_get_user_settings(db, user_id)` (new helper function)
    - `get_french_only_ids(db, user_id)`
    - `get_language_exempt_ids(db, user_id)`
    - `get_large_whitelist_ids(db, user_id)`
  - Sonarr slug map fetch runs after (depends on user_settings result)
- Added `_get_user_settings()` helper function for async user settings retrieval
- All 696 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-59.4: Optimize sync season size calculation**
- Optimized `backend/app/services/sync.py` `calculate_season_sizes()` function
  - Added `fetch_series_episodes()`: Fetches all episodes for a series in one call (vs per-season)
  - Added `check_episodes_languages()`: Inline language check on already-fetched episodes (vs separate API calls)
  - Refactored `calculate_season_sizes()`:
    - Fetch seasons ONCE per series (reused for size + language check)
    - Fetch episodes ONCE per season (reused for size + language + watch data base)
    - Batch user watch data at series level: 1 call per user per series (not per season)
  - API call reduction: From (2 + 2N + N×U) to (1 + N + U) per series
    - Example with 5 seasons, 15 users: 87 calls → 21 calls (76% reduction)
- Added test `test_calculate_season_sizes_optimized_api_calls` to verify optimization
- All 697 tests pass, mypy clean, 37 integration tests pass, Docker verified

**US-60.1: Add content router tests**
- Created `backend/tests/test_content_cache_service.py` with 21 tests covering:
  - `TestGetUserSettings`: 3 tests for get_user_settings() function
  - `TestLookupJellyseerrMediaByTmdb`: 4 tests for lookup by TMDB ID and media type
  - `TestLookupJellyseerrMediaByRequestId`: 3 tests for lookup by Jellyseerr request ID
  - `TestDeleteCachedMediaByTmdbId`: 5 tests for delete with TMDB ID filtering
  - `TestDeleteCachedJellyseerrRequestByTmdbId`: 3 tests for delete requests by TMDB
  - `TestDeleteCachedJellyseerrRequestById`: 3 tests for delete requests by ID
- All tests verify user isolation (user_id filtering) and edge cases
- Coverage: content.py (facade) 100%, content_cache.py 100%
- Note: Functions were moved from router to service in US-57.4
- All 718 tests pass, mypy clean

**US-60.2: Add auth router tests**
- Added `TestGetClientIp` class to `backend/tests/test_auth.py` with 6 tests:
  - test_get_client_ip_from_x_forwarded_for_single_ip: Single IP extraction
  - test_get_client_ip_from_x_forwarded_for_multiple_ips: Multiple IPs (picks first client IP)
  - test_get_client_ip_from_x_forwarded_for_with_whitespace: Whitespace stripping
  - test_get_client_ip_fallback_to_client_host: Fallback when X-Forwarded-For missing
  - test_get_client_ip_unknown_when_no_client: Returns "unknown" when client is None
  - test_get_client_ip_x_forwarded_for_takes_precedence: XFF takes precedence over client.host
- Added `TestChangePassword` class with 6 tests:
  - test_change_password_success: Full flow - change password, verify old fails, new works
  - test_change_password_wrong_current_password: Returns 400 with error message
  - test_change_password_requires_authentication: Returns 401 without token
  - test_change_password_weak_new_password: Returns 422 for short password
  - test_change_password_missing_current_password: Returns 422
  - test_change_password_missing_new_password: Returns 422
- Existing tests already cover: send_signup_notification (5 tests), send_blocked_signup_notification (2 tests), signup disabled flow (4 tests)
- All 730 tests pass (728 unit + 2 integration skipped without Docker), mypy clean

**US-60.3: Add jellyfin service tests**
- Created `backend/tests/test_jellyfin_service.py` with 24 tests covering all 4 functions:
  - `TestValidateJellyfinConnection` (11 tests):
    - test_returns_true_on_200_success: Success path verification
    - test_uses_system_info_endpoint: Correct /System/Info endpoint called
    - test_sends_api_key_header: X-Emby-Token header sent correctly
    - test_normalizes_trailing_slash: URL normalization (no double slashes)
    - test_returns_false_on_401_unauthorized: Invalid API key handling
    - test_returns_false_on_403_forbidden: Access denied handling
    - test_returns_false_on_404_not_found: Wrong URL handling
    - test_returns_false_on_500_server_error: Server error handling
    - test_returns_false_on_timeout: Timeout exception handling
    - test_returns_false_on_connection_error: Connection refused handling
    - test_returns_false_on_dns_error: DNS failure handling
  - `TestGetUserJellyfinSettings` (3 tests): None when no settings, returns settings, user isolation
  - `TestSaveJellyfinSettings` (5 tests): Create new, update existing, trailing slash, encryption, user isolation
  - `TestGetDecryptedJellyfinApiKey` (5 tests): None key, decryption, empty string, special chars, unicode
- Coverage: jellyfin.py 100% (31/31 statements)
- All 754 tests pass, mypy clean

**US-60.4: Add nicknames service tests**
- Created `backend/tests/test_nicknames_service.py` with 17 tests covering all 4 functions:
  - `TestCreateNickname` (4 tests):
    - test_creates_nickname_successfully: Success path verification
    - test_raises_valueerror_on_duplicate: Duplicate detection raises ValueError
    - test_allows_same_username_for_different_users: User isolation verification
    - test_nickname_created_at_is_set: Timestamp automatically set
  - `TestGetNicknames` (5 tests):
    - test_returns_empty_list_for_user_with_no_nicknames: Empty list handling
    - test_returns_nicknames_ordered_alphabetically: Ordering by jellyseerr_username
    - test_returns_only_user_specific_nicknames: User isolation verification
    - test_returns_nickname_item_with_all_fields: All NicknameItem fields present
    - test_created_at_is_formatted_as_iso_string: ISO format datetime string
  - `TestUpdateNickname` (4 tests):
    - test_updates_nickname_successfully: Success path returns True
    - test_returns_false_when_nickname_not_found: Non-existent ID returns False
    - test_returns_false_when_nickname_belongs_to_other_user: User isolation
    - test_preserves_other_fields_when_updating: Only display_name changes
  - `TestDeleteNickname` (4 tests):
    - test_deletes_nickname_successfully: Success path returns True
    - test_returns_false_when_nickname_not_found: Non-existent ID returns False
    - test_returns_false_when_nickname_belongs_to_other_user: User isolation
    - test_does_not_affect_other_users_nicknames: Only deletes specified item
- Coverage: nicknames.py 100% (all service functions tested)
- All 771 tests pass, mypy clean

**US-60.5: Add sonarr service tests**
- Created `backend/tests/test_sonarr_service.py` with 54 tests covering all 8 functions:
  - `TestValidateSonarrConnection` (11 tests):
    - test_returns_true_on_200_success: Success path verification
    - test_uses_system_status_endpoint: Correct /api/v3/system/status endpoint called
    - test_sends_api_key_header: X-Api-Key header sent correctly
    - test_normalizes_trailing_slash: URL normalization (no double slashes)
    - test_returns_false_on_401_unauthorized: Invalid API key handling
    - test_returns_false_on_403_forbidden: Access denied handling
    - test_returns_false_on_404_not_found: Wrong URL handling
    - test_returns_false_on_500_server_error: Server error handling
    - test_returns_false_on_timeout: Timeout exception handling
    - test_returns_false_on_connection_error: Connection refused handling
    - test_returns_false_on_dns_error: DNS failure handling
  - `TestGetUserSonarrSettings` (3 tests): None when no settings, returns settings, user isolation
  - `TestSaveSonarrSettings` (5 tests): Create new, update existing, trailing slash, encryption, user isolation
  - `TestGetDecryptedSonarrApiKey` (5 tests): None key, decryption, empty string, special chars, unicode
  - `TestGetSonarrSeriesByTmdbId` (10 tests): Match, not found, empty, non-200, timeout, connection error, endpoint, trailing slash, missing tmdbId, None id
  - `TestGetSonarrTmdbToSlugMap` (9 tests): Mapping, empty, non-200, timeout, connection error, missing fields, empty slug, trailing slash
  - `TestDeleteSonarrSeries` (7 tests): Success, URL, delete_files params, non-200, timeout, connection error
  - `TestDeleteSeriesByTmdbId` (4 tests): Lookup and delete flows, not found, delete fails, delete_files param
- Coverage: sonarr.py 100% (all service functions tested)
- All 788 tests pass, mypy clean

**US-60.6: Add radarr service tests**
- Created `backend/tests/test_radarr_service.py` with 46 tests covering all 7 functions:
  - `TestValidateRadarrConnection` (11 tests):
    - test_returns_true_on_200_success: Success path verification
    - test_uses_system_status_endpoint: Correct /api/v3/system/status endpoint called
    - test_sends_api_key_header: X-Api-Key header sent correctly
    - test_normalizes_trailing_slash: URL normalization (no double slashes)
    - test_returns_false_on_401_unauthorized: Invalid API key handling
    - test_returns_false_on_403_forbidden: Access denied handling
    - test_returns_false_on_404_not_found: Wrong URL handling
    - test_returns_false_on_500_server_error: Server error handling
    - test_returns_false_on_timeout: Timeout exception handling
    - test_returns_false_on_connection_error: Connection refused handling
    - test_returns_false_on_dns_error: DNS failure handling
  - `TestGetUserRadarrSettings` (3 tests): None when no settings, returns settings, user isolation
  - `TestSaveRadarrSettings` (5 tests): Create new, update existing, trailing slash, encryption, user isolation
  - `TestGetDecryptedRadarrApiKey` (5 tests): None key, decryption, empty string, special chars, unicode
  - `TestGetRadarrMovieByTmdbId` (9 tests): Match, empty, non-200, timeout, connection error, endpoint, trailing slash, None id, multiple matches
  - `TestDeleteRadarrMovie` (8 tests): Success, URL, delete_files params, non-200, timeout, connection error, trailing slash
  - `TestDeleteMovieByTmdbId` (5 tests): Lookup and delete flows, not found, delete fails, delete_files param, default param
- Coverage: radarr.py 100% (all service functions tested)
- All 834 tests pass, mypy clean

**US-60.7: Add tasks module tests**
- Created `backend/tests/test_tasks.py` with 24 tests covering all task functions:
  - `TestGetConfiguredUserIds` (4 tests):
    - test_returns_empty_list_when_no_users_configured: Empty list when no settings
    - test_returns_user_ids_with_jellyfin_configured: Returns users with URL + API key
    - test_excludes_users_with_only_server_url: Excludes incomplete configs
    - test_excludes_users_with_only_api_key: Excludes incomplete configs
  - `TestSendSyncFailureNotificationForCeleryLogic` (6 tests):
    - test_notification_called_with_user_email: _get_user_email returns correct email
    - test_fallback_email_when_user_not_found: Uses user_X format when no email
    - test_get_user_email_returns_none_for_nonexistent_user: None for missing user
    - test_notification_wrapper_logs_warning_on_exception: Logs warning, doesn't raise
    - test_notification_wrapper_sends_with_correct_params: Correct service/error params
    - test_notification_wrapper_uses_fallback_email: Fallback email used when None
  - `TestSyncUserTaskLogic` (6 tests):
    - test_run_sync_for_user_calls_service: Calls run_user_sync correctly
    - test_sync_user_success_path: Returns sync result on success
    - test_sync_user_failure_returns_error_dict: Returns failed status on exception
    - test_sync_user_failure_sends_notification: Calls notification on failure
    - test_sync_user_failure_logs_error: Logs error with user ID
    - test_sync_user_logs_info_on_success: Logs start and completion
  - `TestGetUserEmail` (2 tests): Email lookup, None for missing user
  - `TestSyncAllUsersTask` (3 tests): Queues each user, handles empty list, logs info
  - `TestTestTask` (3 tests): Success with input, empty string, special chars
- All 856 tests pass, mypy clean

---

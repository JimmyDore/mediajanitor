# Plex Dashboard - Progress Log

# Codebase Patterns

Reusable patterns discovered during development. Update this section when you find something useful for future iterations.

## Backend Patterns

### Async Database Sessions
- Always use `AsyncSession` with `async def` endpoints
- Use `await db.execute()` then `.scalar_one_or_none()`
- Tests must also use async sessions to match production

### Password Hashing
- Use `bcrypt` directly (not passlib) for Python 3.12+ compatibility
- `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt())`

### Encrypted User Settings
- Use Fernet from `app/services/encryption.py`
- Store `*_encrypted` fields, return `*_configured` booleans in API responses
- Never return actual API keys in GET responses

### Protected Routes
- Use `get_current_user` dependency from `app/services/auth.py`
- Returns 401 if token invalid/missing

## Frontend Patterns

### API Contract Testing (vitest)
- Location: `frontend/tests/*.test.ts`
- Mock `fetch` with `vi.fn()`
- Test success, 401, 422 responses
- Example: `login.test.ts`, `register.test.ts`

### Auth Store
- Location: `frontend/src/lib/stores/auth.ts`
- Methods: `checkAuth()`, `logout()`, `setUser()`
- Layout checks auth on mount, redirects to /login if not authenticated

### E2E Testing (Playwright)
- Location: `frontend/e2e/*.spec.ts`
- Mock API responses with `page.route()`
- Test UI rendering, not business logic

## Docker Verification
- Always test backend changes in Docker before marking complete
- `docker-compose up --build -d`
- Test via curl: `curl -X POST http://localhost:8080/api/...`
- Check logs: `docker-compose logs backend`

---

## Completed Tasks

### 2026-01-15: US-32.1 - Refresh Token Backend Implementation
- Created RefreshToken database model with:
  - id, user_id (FK), token_hash (SHA-256), expires_at, created_at
  - Unique index on token_hash for fast lookups
- Created Alembic migration for refresh_tokens table
- Updated config.py:
  - access_token_expire_minutes: 30 → 15 (short-lived)
  - Added refresh_token_expire_days: 30 (long-lived)
- Implemented auth service functions:
  - generate_refresh_token(): Cryptographically secure token generation
  - hash_refresh_token(): SHA-256 hashing (stored in DB, not the raw token)
  - create_refresh_token(): Creates and stores hashed token
  - validate_refresh_token(): Validates token exists and not expired
  - rotate_refresh_token(): Invalidates old, creates new (security best practice)
  - invalidate_refresh_token(): Deletes token by hash
  - get_user_by_id_async(): Helper for refresh endpoint
- Updated POST /api/auth/login:
  - Returns TokenWithRefresh: access_token, token_type, expires_in (900 seconds)
  - Sets refresh_token as httpOnly cookie (30 days, secure, samesite=lax)
- Created POST /api/auth/refresh:
  - Accepts refresh token via cookie or request body
  - Rotates token (old invalidated, new issued)
  - Returns new access token
- Created POST /api/auth/logout:
  - Invalidates refresh token in database
  - Clears refresh token cookie
  - Returns 204 No Content
- Updated Pydantic models:
  - TokenWithRefresh: access_token, token_type, expires_in
  - RefreshTokenRequest: optional refresh_token for non-cookie clients
- Added TESTING env var check for cookie settings (path, secure flags)
- 8 new unit tests for refresh token functionality:
  - test_refresh_success_with_cookie
  - test_refresh_without_token_returns_401
  - test_refresh_with_invalid_token_returns_401
  - test_refresh_rotates_token (verifies old token invalidated)
  - test_refresh_via_request_body
  - test_logout_success
  - test_logout_without_token_succeeds
  - test_logout_clears_cookie
- 286 backend unit tests pass, 17 integration tests pass, mypy clean
- Verified in Docker: login, refresh, rotation, logout all work correctly
- Files changed: config.py, database.py, models/user.py, routers/auth.py, services/auth.py, tests/conftest.py, tests/test_auth.py, alembic migration
- Commits:
  - feat(auth): [US-32.1] add refresh token backend implementation

### 2026-01-15: US-32.2 - Frontend Token Refresh
- Refactored auth store to use in-memory token storage instead of localStorage:
  - accessToken and tokenExpiresAt stored in module-level variables
  - Removed localStorage.getItem/setItem/removeItem for access_token
  - auth.setToken(token, expiresIn) stores token in memory with expiration
  - auth.getToken() returns current in-memory token
- Implemented refreshAccessToken() method:
  - Calls POST /api/auth/refresh with credentials: 'include' for httpOnly cookie
  - Updates in-memory token on success
  - Returns boolean for success/failure
- Implemented proactive token refresh:
  - scheduleTokenRefresh() sets timer to refresh 60 seconds before expiration
  - Timer cleared on logout or token change
- Updated logout to invalidate refresh token:
  - Calls POST /api/auth/logout endpoint
  - Clears in-memory tokens
  - Clears refresh timer
- Created authenticatedFetch() wrapper:
  - Adds Authorization header with Bearer token
  - Includes credentials: 'include' for cookies
  - On 401 response: attempts token refresh and retries original request
  - Returns original 401 response if refresh fails
- Updated all frontend pages to use authenticatedFetch:
  - +page.svelte (dashboard): syncStatus, contentSummary, triggerSync
  - settings/+page.svelte: all loadCurrentSettings and submit handlers
  - issues/+page.svelte: fetchIssues, fetchConfigStatus, all whitelist actions
  - whitelist/+page.svelte: fetchAll, removeItem
  - info/recent/+page.svelte: onMount fetch
  - info/airing/+page.svelte: onMount fetch
  - content/old-unwatched/+page.svelte: protectContent, fetchOldUnwatchedContent
- Updated login page to use credentials: 'include' and store token via auth.setToken()
- Updated theme store to use getAccessToken() instead of localStorage
- New frontend tests: 10 tests for token refresh API integration (token-refresh.test.ts)
- Updated theme.test.ts to use auth.setToken() for test setup
- 232 frontend tests pass, typecheck passes
- Verified in browser: login, navigation, API calls all work correctly
- Files changed: stores/index.ts, +page.svelte (dashboard), settings/+page.svelte, issues/+page.svelte, whitelist/+page.svelte, info/recent/+page.svelte, info/airing/+page.svelte, content/old-unwatched/+page.svelte, login/+page.svelte, theme.test.ts, token-refresh.test.ts
- Commits:
  - feat(auth): [US-32.2] add frontend token refresh implementation

### 2026-01-15: US-32.3 - Auto-Redirect on Session Expiration
- Added session expiration handling to authenticatedFetch:
  - When refresh token fails (401), clear auth state and trigger redirect
  - Redirect includes ?redirect=/original/path query param for return after login
  - Session expiration handler is registered by layout component
- Updated layout.svelte:
  - Added redirectToLogin() helper function with optional redirect path
  - Registered onSessionExpired handler showing toast "Session expired, please log in again"
  - Protected routes now redirect with original path preserved
- Updated login page:
  - Reads ?redirect query param from URL
  - After successful login, navigates to redirect path (defaults to /)
  - If already authenticated, redirect to intended destination immediately
- Frontend tests: 12 new tests for session expiration behavior (session-expiration.test.ts)
  - Tests for 401 after failed refresh triggering session expiration
  - Tests for redirect query param encoding/decoding
  - Tests for protected vs public route handling
- 244 frontend tests pass, typecheck passes
- Verified in browser: login with ?redirect=/settings correctly redirects to /settings
- Files changed: stores/index.ts, +layout.svelte, login/+page.svelte, session-expiration.test.ts, prd.json
- Commits:
  - feat(auth): [US-32.3] add auto-redirect on session expiration

### 2026-01-15: US-29.1 - Issues Table Name Column Improvements
- Refactored Issues table Name column layout for better visual alignment:
  - Changed from flexbox to CSS grid layout with fixed columns
  - Year now displays at fixed horizontal position (40px min-width, right-aligned)
  - Year uses monospace font for consistent digit alignment
  - Shows "—" when year is null (instead of hiding)
- Added title truncation with ellipsis:
  - Long titles truncate with CSS text-overflow: ellipsis
  - Native title tooltip shows full text on hover
- Added new Requester column for Unavailable tab:
  - Column header and data cells conditionally rendered when filter=requests
  - Displays username from requested_by field, or "—" if null
  - Follows same conditional pattern as Release column
- Removed inline 'by {username}' display from name cell
- Service badges now align consistently across rows (using grid auto columns)
- 244 frontend tests pass, typecheck passes
- Verified in browser: both All and Unavailable tabs display correctly
- Files changed: frontend/src/routes/issues/+page.svelte, prd.json
- Commits:
  - feat(ui): [US-29.1] improve Issues table visual alignment

### 2026-01-15: US-30.1 - Remove Currently Airing Placeholder
- Removed all currently airing placeholder code:
  - Backend: Removed GET /api/info/airing endpoint from info.py router
  - Backend: Removed get_currently_airing() function from content.py service
  - Models: Removed CurrentlyAiringItem and CurrentlyAiringResponse from content.py
  - Models: Removed currently_airing field from ContentSummaryResponse
  - Frontend: Deleted /info/airing route and page entirely
  - Frontend: Removed 'currently airing' link from dashboard info section
  - Frontend: Removed info-separator CSS class (no longer needed)
- Updated tests:
  - Backend: Removed 2 currently airing tests from test_content.py
  - Backend: Updated test_integration.py to not check for currently_airing
  - Frontend: Removed 4 currently airing tests from info.test.ts
- Dashboard info section now shows only 'recently available'
- 303 backend tests pass, mypy clean
- 241 frontend tests pass, typecheck clean
- 17 integration tests pass
- Verified: /api/info/airing returns 404
- Files changed: info.py, content.py, models/content.py, test_content.py, test_integration.py, +page.svelte (dashboard), info/airing/+page.svelte (deleted), info.test.ts
- Commits:
  - chore(cleanup): [US-30.1] remove currently airing placeholder

### 2026-01-15: US-31.1 - Recently Available Days Setting (Backend)
- Added recently_available_days field to UserSettings model (nullable Integer, default: 7)
- Created Alembic migration for new column
- Extended GET /api/settings/display to return recently_available_days
- Extended POST /api/settings/display to accept recently_available_days (range: 1-30)
- Created get_user_recently_available_days() helper function in content service
- Updated get_recently_available() to use user's setting instead of hardcoded 7 days
- Updated get_recently_available_count() to use user's setting for summary
- Invalid values return 422 with validation error
- 5 new unit tests for display preferences (recently_available_days)
- 3 new unit tests for info/recent and content/summary using user setting
- 2 new integration tests for display settings
- 294 backend unit tests pass, 19 integration tests pass, mypy clean
- Verified in Docker: GET/POST /api/settings/display with recently_available_days works
- Files changed: database.py, models/settings.py, routers/settings.py, services/content.py, test_content.py, test_integration.py, test_settings.py, alembic migration
- Commits:
  - feat(settings): [US-31.1] add recently available days setting

### 2026-01-15: US-31.2 - Recently Available Days Setting (Frontend)
- Added recentlyAvailableDays state to Settings page
- Load recently_available_days from GET /api/settings/display on mount
- Added handleRecentDaysChange() that saves on input change
- Added number input in Display section with:
  - Label: "Recently available days"
  - Help text: "Show content that became available in the past N days"
  - min=1, max=30 validation
  - Inline spinner during save
- Updated Recently Available page (/info/recent):
  - Fetch user's recently_available_days setting on mount
  - Dynamic subtitle: "Content that became available in the past {N} days"
  - Dynamic empty state message
- Frontend tests: 5 new tests for recently_available_days API integration
- 246 frontend tests pass, typecheck clean
- Verified in browser: setting at 14 days shows 8 items, subtitle shows "past 14 days"
- Files changed: settings/+page.svelte, info/recent/+page.svelte, settings-display.test.ts
- Commits:
  - feat(settings): [US-31.2] add recently available days frontend setting

### 2026-01-15: US-31.3 - User Nickname Mapping (Backend)
- Created UserNickname database model with fields:
  - id, user_id (FK), jellyseerr_username, display_name, created_at
  - UniqueConstraint on (user_id, jellyseerr_username)
- Created Alembic migration: add_user_nicknames_table
- Added Pydantic models in models/settings.py:
  - NicknameCreate: Request model for creating mappings
  - NicknameUpdate: Request model for updating display_name
  - NicknameItem: Response model for single mapping
  - NicknameListResponse: Response model for list
- Implemented service functions in services/nicknames.py:
  - create_nickname(): Creates new mapping, raises ValueError on duplicate
  - get_nicknames(): Returns all mappings for user, alphabetically sorted
  - update_nickname(): Updates display_name by ID
  - delete_nickname(): Deletes mapping by ID
- Implemented REST endpoints in routers/settings.py:
  - GET /api/settings/nicknames: List all mappings for user
  - POST /api/settings/nicknames: Create new mapping (201 Created)
  - PUT /api/settings/nicknames/{id}: Update mapping display_name
  - DELETE /api/settings/nicknames/{id}: Delete mapping
- 409 Conflict returned when trying to create duplicate username mapping
- 404 Not Found returned when updating/deleting non-existent mapping
- Empty string validation rejects jellyseerr_username="" and display_name=""
- User isolation: each user has separate namespace for mappings
- 13 unit tests in TestNicknameSettings class
- 2 integration tests for CRUD operations
- 307 backend unit tests pass, 21 integration tests pass, mypy clean
- Files changed: database.py, models/settings.py, routers/settings.py, services/nicknames.py, test_settings.py, test_integration.py, alembic migration
- Commits:
  - feat(settings): [US-31.3] add user nickname mapping backend

### 2026-01-15: US-31.4 - User Nickname Mapping (Frontend)
- Added User Nicknames section to Settings page below services configuration
- Implemented table view showing Jellyseerr Username → Display Name mappings
- Added inline add form with two inputs: jellyseerr username, display name
- Added inline edit mode for updating display names only
- Added delete confirmation mode showing "Delete this nickname?" before removal
- Implemented empty state message: "No nicknames configured. Add nicknames to customize how requesters appear in notifications."
- Added toast feedback for all CRUD operations (add, edit, delete success/error)
- Created 14 new frontend unit tests in settings-nicknames.test.ts
- Frontend typecheck passes, 260 unit tests pass
- Verified in browser: add, edit, delete, confirmation all working
- Files changed: routes/settings/+page.svelte, tests/settings-nicknames.test.ts, prd.json
- Commits:
  - feat(settings): [US-31.4] add user nickname mapping frontend

### 2026-01-15: US-31.5 - Copy Output Grouped by Requester
- Added display_name field to RecentlyAvailableItem Pydantic model
- Implemented get_nickname_map() in content service to fetch user's nickname mappings
- Implemented resolve_display_name() to resolve Jellyseerr username to display name
- Updated get_recently_available() to include resolved display_name in API response
- Updated frontend copy function to group items by requester (alphabetically)
- Items under each requester sorted by availability date (newest first)
- Items without requester grouped under 'Unknown' at the end
- Frontend table now displays display_name instead of requested_by
- Copy output format: `{display_name}:\n  - {Title} ({Type}) - available since {Date}`
- Added 4 backend tests for display_name resolution in TestRecentlyAvailableDisplayName
- Added 3 frontend tests for display_name API contract in info.test.ts
- 332 backend tests pass, 263 frontend tests pass, mypy clean, typecheck clean
- Files changed: models/content.py, services/content.py, test_content.py, info/recent/+page.svelte, info.test.ts, prd.json
- Commits:
  - feat(info): [US-31.5] copy output grouped by requester

### 2026-01-15: US-17.1 - Multi-User Watch Data Aggregation
- Implemented multi-user watch data aggregation for accurate Old/Unwatched detection
- Added aggregate_user_watch_data() function:
  - played = True if ANY user has watched
  - last_played_date = most recent date across all users
  - play_count = sum of all users' play counts
- Added fetch_jellyfin_users() to get all Jellyfin users from API
- Added fetch_user_items() to fetch items for a specific user with progress logging
- Added fetch_all_users_media() with asyncio.gather() for parallel user fetches
- Updated fetch_jellyfin_media() to use new multi-user aggregation approach
- Progress logging shows: "Fetching user 3/10: John" for each user
- 8 new tests for aggregation logic in TestMultiUserWatchDataAggregation
- 340 backend tests pass (+8 new), 21 integration tests pass, mypy clean
- Files changed: app/services/sync.py, tests/test_sync.py, prd.json
- Commits:
  - feat(sync): [US-17.1] add multi-user watch data aggregation

### 2026-01-15: US-17.2 - Sync Progress Visibility
- Added progress tracking fields to SyncStatus database model:
  - current_step: "syncing_media" or "syncing_requests"
  - total_steps: 1 or 2 (Jellyfin only, or Jellyfin + Jellyseerr)
  - current_step_progress: current user being processed
  - current_step_total: total users to process
  - current_user_name: name of current Jellyfin user
- Created Alembic migration: add_sync_progress_fields
- Added update_sync_progress() function for updating progress during sync
- Created fetch_jellyfin_media_with_progress() that processes users in batches:
  - Batch size of 3 for visible progress updates
  - Updates progress per batch with first user's name
  - Same aggregation logic as fetch_all_users_media()
- Updated run_user_sync() to use progress-aware function
- Updated GET /api/sync/status to return:
  - is_syncing: boolean flag when sync is in progress
  - progress: object with current_step, total_steps, etc.
- Updated frontend dashboard to poll every 2 seconds during sync:
  - startPolling()/stopPolling() with setInterval
  - formatProgressMessage() displays e.g. "Fetching user 3/10: John..."
  - Progress shown in header next to "Dashboard" title
  - onDestroy() cleanup stops polling
- 5 new backend unit tests in TestSyncProgressTracking
- 3 new frontend unit tests for progress API contract
- 345 backend tests pass, 266 frontend tests pass, mypy clean, typecheck clean
- Verified in browser: sync triggers correctly, rate limiting works
- Files changed: database.py, routers/sync.py, services/sync.py, test_sync.py, +page.svelte, sync.test.ts, prd.json, alembic migration
- Commits:
  - feat(sync): [US-17.2] add sync progress visibility

### 2026-01-15: US-17.3 - Fix Mobile Sidebar Visual Overlap
- Fixed sidebar showing a blue strip on mobile when closed
- Root cause: transform: translateX(-100%) only moved the element visually but didn't hide it
- Added visibility: hidden when sidebar is not open on mobile (< 768px)
- Added visibility: visible when sidebar.open class is applied
- Sidebar now completely hidden when closed, opens/closes correctly
- 266 frontend tests pass, typecheck clean
- Verified in browser: no blue strip visible, hamburger menu works
- Files changed: frontend/src/lib/components/Sidebar.svelte, prd.json
- Commits:
  - fix(ui): [US-17.3] hide mobile sidebar completely when closed

### 2026-01-15: US-19.1 - Search Issues by Text
- Added search input to Issues page header below title/stats
- Implemented debounced filtering (300ms) using setTimeout
- Search matches against:
  - Title (case-insensitive)
  - Production year
  - requested_by field (for Unavailable/Requests tab)
- Item count updates to show "X of Y items" format when search is active
- Total size updates to reflect filtered results
- Added clear (X) button that appears when search text is present
- Search operates within currently active tab filter
- CSS: search-container with search-input and search-clear button
- 24 new frontend unit tests in issues-search.test.ts
- 290 frontend tests pass, typecheck clean
- Verified in browser: search by title, year, and requester all work correctly
- Files changed: frontend/src/routes/issues/+page.svelte, frontend/tests/issues-search.test.ts, prd.json
- Commits:
  - feat(issues): [US-19.1] add search filtering for Issues page

### 2026-01-15: US-23.1 - Added Date Column on Issues Page
- Added date_created field to ContentIssueItem Pydantic model
- Updated get_content_issues() in content service to include date_created from CachedMediaItem
- Added 'Added' column to Issues table (positioned after Size column)
- Implemented formatDateCreated() function for user-friendly date display (e.g., "Jan 15, 2024")
- Added 'added' to SortField type and implemented sorting in getSortedItems()
- Added CSS styling for .col-added (12% width, right-aligned)
- Column shows "—" for request items (they have no date_created)
- Responsive: column hidden on mobile (< 768px) alongside Watched column
- 3 new frontend unit tests for date_created field handling
- 345 backend tests pass, 293 frontend tests pass, typecheck clean
- Verified in browser: column displays correctly, sorting works
- Files changed: backend/app/models/content.py, backend/app/services/content.py, frontend/src/routes/issues/+page.svelte, frontend/tests/issues.test.ts, prd.json
- Commits:
  - feat(issues): [US-23.1] add Added date column to Issues page

### 2026-01-15: US-18.1 - Show Setup Checklist for New Users
- Added Setup Checklist component to Dashboard for new user onboarding
- Checklist shows when Jellyfin not configured OR user has never synced
- Two steps displayed:
  1. "Connect Jellyfin" - links to /settings page
  2. "Run First Sync" - shows "Start Sync" button when Jellyfin is configured
- Step states with visual indicators:
  - pending: gray circle with step number
  - in-progress: blue spinner (for sync step)
  - complete: green checkmark
- Added JellyfinSettings interface and fetchJellyfinSettings() function
- Added $derived computed properties for showSetupChecklist, jellyfinStepStatus, syncStepStatus
- Checklist hides automatically when both steps are complete
- 10 new unit tests in setup-checklist.test.ts for API integration
- 303 frontend tests pass, typecheck clean
- Verified in browser: checklist shows for new users, hides for configured users
- Files changed: frontend/src/routes/+page.svelte, frontend/tests/setup-checklist.test.ts, prd.json
- Commits:
  - feat(dashboard): [US-18.1] add setup checklist for new users

### 2026-01-15: US-18.2 - Auto-Sync After Jellyfin Configuration
- Added SyncRequest Pydantic model with force: bool parameter
- Updated POST /api/sync to accept force parameter in request body
- First sync (last_sync_completed is None) bypasses rate limit when force=True
- Subsequent syncs cannot bypass rate limit even with force=True
- Settings page detects if user has never synced via GET /api/sync/status
- After first Jellyfin config + never synced, shows toast and navigates to dashboard
- Dashboard auto-triggers sync via $effect when:
  - Jellyfin configured (api_key_configured=true)
  - Never synced (last_synced=null)
  - Not currently syncing (is_syncing=false)
  - Not already triggered (autoSyncTriggered flag)
- Added 'error' state to syncStepStatus for failed syncs
- Checklist shows error state with Retry button when sync fails
- triggerSync() now accepts force parameter for first sync bypass
- 2 new backend tests for force parameter behavior
- 6 new frontend tests for auto-sync feature and error state
- 349 backend tests pass, 309 frontend tests pass, typecheck clean
- Files changed: backend/app/routers/sync.py, backend/tests/test_sync.py, frontend/src/routes/+page.svelte, frontend/src/routes/settings/+page.svelte, frontend/tests/setup-checklist.test.ts, prd.json
- Commits:
  - feat(onboarding): [US-18.2] add auto-sync after Jellyfin configuration

### 2026-01-15: US-18.3 - Optional Services Prompt
- Added dismissible "Enhance your setup" card to Dashboard
- Card shows after setup checklist complete but optional services not configured
- Fetches Jellyseerr, Radarr, Sonarr settings via API
- Displays only unconfigured services with Configure link to /settings
- Service descriptions: Jellyseerr (request tracking), Radarr (movie management), Sonarr (TV management)
- Dismiss button (X) persists state in localStorage (mediajanitor_enhance_setup_dismissed)
- Card visibility computed via showEnhanceSetup derived state
- fetchOptionalServicesSettings() fetches all three services in parallel
- loadEnhanceSetupDismissed() and dismissEnhanceSetup() handle localStorage
- 15 new tests in enhance-setup.test.ts for visibility and dismiss logic
- 324 frontend tests pass, typecheck clean
- Files changed: frontend/src/routes/+page.svelte, frontend/tests/enhance-setup.test.ts, prd.json
- Commits:
  - feat(onboarding): [US-18.3] add optional services prompt after setup

## Current Status

**Phase**: Epic 18 - User Onboarding (Complete)
**Total Stories**: 41 stories (23 passes: true, 18 remaining)

## Notes

- US-0.2 (Dockerize) was completed together with US-0.1 since Docker setup was needed for testing
- Backend runs on port 8080 (mapped from 8000), Frontend on port 5173
- API proxy configured in vite.config.ts for dev environment
- Production: https://mediajanitor.com with HTTPS via Let's Encrypt
- CI/CD: Push to main triggers auto-deploy to VPS